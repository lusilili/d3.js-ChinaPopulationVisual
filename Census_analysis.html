<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset='utf-8'>
    <title>MultiViewCase</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">
    <script type='text/javascript' src='./Resources/lib/d3.js'></script>
    <script src='./Resources/lib/d3.layout.cloud.js'></script>
    <style>
        * {
            margin: 0px;
            padding: 0px;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif; /* è®¾ç½®å…¨å±€å­—ä½“ */
            width: 100%;
            height: 840px;
            background-color: #f4f4f9; /* ä½¿ç”¨æ›´ç°ä»£çš„æµ…ç°è‰²èƒŒæ™¯ */
            /* background-color: #fae8dbd1; /* æ›´æ·¡çš„é™¶åœŸè‰² */
            cursor: url('./Resources/images/cursor_China.png'), auto; /* æ·»åŠ è‡ªå®šä¹‰é¼ æ ‡æŒ‡é’ˆ */
        }
        
        a {
            cursor: url('./Resources/images/Hand_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
        }

        button {
            cursor: url('./Resources/images/Hand_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
        }

        .clickable {
            cursor: url('./Resources/images/Hand_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
        }


        #title {
            text-align: center;
            height: 40px;
            font-size: 30px;
        }
        
        #view {
            display: flex;
            height: 800px;
        }
        
        #leftview {
            /* å·¦è¾¹å æ€»å®½åº¦60% */
            flex: 3;
            display: flex;
            flex-direction: column;
        }
        
        #rightview {
            /* å³è¾¹å æ€»å®½åº¦40% */
            flex: 2;
            display: flex;
            flex-direction: column;
        }
        
        #topleft {
            /* å·¦ä¸Šå æ€»é«˜åº¦70% */
            flex: 6;
            /* border: 1px dotted red; */
        }
        
        #bottomleft {
            /* å·¦ä¸‹å æ€»é«˜åº¦30% */
            flex: 4;
            /* border: 1px dotted red; */
        }
        
        #topright {
            /* å³ä¸Šå æ€»é«˜åº¦50% */
            flex: 1;
            /* border: 1px dotted red; */
        }
        
        #bottomright {
            /* å³ä¸‹å æ€»é«˜åº¦50% */
            flex: 1;
            /* border: 1px dotted red; */
        }

        #optionBar {
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            cursor: url('./Resources/images/Hand_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .option {
            padding: 10px 20px;
            margin: 5px 0;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: url('./Resources/images/Hand_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
            transition: background-color 0.3s, border-color 0.3s;
        }

        .option:hover {
            background-color: #e0e0e0;
            border-color: #ccc;
        }

        .option.active {
            background-color: #d0d0d0;
            border-color: #bbb;
        }

        .sub-options {
            display: none;
            flex-direction: column;
            width: 100%;
            align-items: center;
            cursor: url('./Resources/images/Hand_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
        }

        .sub-option {
            padding: 5px 20px;
            margin: 2px 0;
            background-color: #ffffff;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: url('./Resources/images/Hand_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
            transition: background-color 0.3s, border-color 0.3s;
        }

        .sub-option:hover {
            background-color: #e0e0e0;
            border-color: #ccc;
        }

        .sub-option.active {
            background-color: #d0d0d0;
            border-color: #bbb;
        }

        #compare-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            cursor: url('./Resources/images/cursor_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
            z-index: 1000;
        }

        #compare-content {
            position: relative;
            width: 80%;
            height: 80%;
            margin: auto;
            background-color: #fff;
            padding: 20px;
            border-radius: 10px;
            overflow: auto;
            display: flex;
        }

        #close-modal {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 30px;
            cursor: url('./Resources/images/cursor_China.png'), pointer; /* æ·»åŠ è‡ªå®šä¹‰æ‰‹æŒ‡æŒ‡é’ˆ */
        }

        #comparison-options {
            display: flex;
            flex-direction: column;
            width: 20%;
        }

        #comparison-options .option {
            display: flex;
            align-items: center;
        }

        #comparison-options .option input {
            margin-right: 10px;
        }

        .heatmap-container {
            width: 48%;
            height: 100%;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .heatmap {
            max-width: 100%;
            max-height: 100%;
            height: auto;
            width: auto;
        }

        #search-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 5px 0;
        }

        #search-box {
            padding: 10px;
            font-size: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-right: 2px;
        }

        #search-btn {
            padding: 10px 20px;
            font-size: 10px;
            border: none;
            border-radius: 5px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

        #search-btn:hover {
            background-color: #45a049;
        }

        #optionBar {
            width: 250px;
            transition: width 0.3s ease;
            overflow: hidden;
            position: relative;
        }

        #optionBar.collapsed {
            width: 50px;
        }

        #optionBar.collapsed .option,
        #optionBar.collapsed .sub-options,
        #optionBar.collapsed #search-container {
            display: none;
        }

        #toggle-sidebar-btn {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
        }

        #toggle-sidebar-btn:hover {
            background-color: #45a049;
        }

        #toggle-sidebar-btn.collapsed {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
        }
    </style>
</head>

<body>
    <header id='title'>ä¸­å›½åœ°åŒºå‘å±•æ°´å¹³æ•°æ®åˆ†æ</header>
    <main id='view'>
        <div id="compare-modal" style="display:none;">
            <div id="compare-content">
                <span id="close-modal">&times;</span>
                <div class="heatmap-container" id="left-comparison"></div>
                <div class="heatmap-container" id="right-comparison"></div>
                <!-- <div id="left-comparison" style="width:50%; float:left;"></div>
                <div id="right-comparison" style="width:50%; float:left;"></div> -->
                <div id="comparison-options">
                    <div class="option" data-year="population">äººå£æ™®æŸ¥ (1953-2020)
                        <div class="sub-options">
                            <div class="sub-option" data-year="1953"><input type="checkbox" name="compare" value="1953">1953å¹´</div>
                            <div class="sub-option" data-year="1964"><input type="checkbox" name="compare" value="1964">1964å¹´</div>
                            <div class="sub-option" data-year="1982"><input type="checkbox" name="compare" value="1982">1982å¹´</div>
                            <div class="sub-option" data-year="1990"><input type="checkbox" name="compare" value="1990">1990å¹´</div>
                            <div class="sub-option" data-year="2000"><input type="checkbox" name="compare" value="2000">2000å¹´</div>
                            <div class="sub-option" data-year="2010"><input type="checkbox" name="compare" value="2010">2010å¹´</div>
                            <div class="sub-option" data-year="2020"><input type="checkbox" name="compare" value="2020">2020å¹´</div>
                        </div>
                    </div>
                    <div class="option" data-year="public_transportation">å…¬å…±äº¤é€šï¼ˆ2020å¹´ï¼‰
                        <div class="sub-options">
                            <div class="sub-option" data-year="bus"><input type="checkbox" name="compare" value="bus">å…¬å…±æ±½ç”µè½¦è¿è¥æ•°</div>
                            <div class="sub-option" data-year="bus_route"><input type="checkbox" name="compare" value="bus_route">å…¬å…±æ±½ç”µè½¦è¿è¥çº¿è·¯æ€»é•¿åº¦</div>
                            <div class="sub-option" data-year="bus_passengers"><input type="checkbox" name="compare" value="bus_passengers">å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡</div>
                            <div class="sub-option" data-year="rail"><input type="checkbox" name="compare" value="rail">è½¨é“äº¤é€šè¿è¥æ•°</div>
                            <div class="sub-option" data-year="rail_mileage"><input type="checkbox" name="compare" value="rail_mileage">è½¨é“äº¤é€šè¿è¥é‡Œç¨‹</div>
                            <div class="sub-option" data-year="rail_passengers"><input type="checkbox" name="compare" value="rail_passengers">è½¨é“äº¤é€šè¿è¥æ€»é‡</div>
                        </div>
                    </div>
                    <div class="option" data-year="urban_facilities">åŸå¸‚è®¾æ–½æ°´å¹³ (2020å¹´)
                        <div class="sub-options">
                            <div class="sub-option" data-year="water"><input type="checkbox" name="compare" value="water">åŸå¸‚ä¾›æ°´æ™®åŠç‡</div>
                            <div class="sub-option" data-year="gas"><input type="checkbox" name="compare" value="gas">åŸå¸‚ç‡ƒæ°”æ™®åŠç‡</div>
                            <div class="sub-option" data-year="trans"><input type="checkbox" name="compare" value="trans">æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†</div>
                            <div class="sub-option" data-year="road"><input type="checkbox" name="compare" value="road">äººå‡åŸå¸‚é“è·¯é¢ç§¯</div>
                            <div class="sub-option" data-year="park"><input type="checkbox" name="compare" value="park">äººå‡å…¬å›­ç»¿åœ°é¢ç§¯</div>
                            <div class="sub-option" data-year="wc"><input type="checkbox" name="compare" value="wc">æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±å•æ‰€</div>
                        </div>
                    </div>
                    <div class="option" data-year="water_supply">åŸå¸‚ä¾›æ°´æƒ…å†µ (2020å¹´)
                        <div class="sub-options">
                            <div class="sub-option" data-year="2020"><input type="checkbox" name="compare" value="2020">2020å¹´</div>
                        </div>
                    </div>
                    <div class="option" data-year="electricity_usage">ç”¨ç”µé‡ (1995-2020å¹´)
                        <div class="sub-options">
                            <div class="sub-option" data-year="1995"><input type="checkbox" name="compare" value="1995">1995å¹´</div>
                            <div class="sub-option" data-year="2000"><input type="checkbox" name="compare" value="2000">2000å¹´</div>
                            <div class="sub-option" data-year="2005"><input type="checkbox" name="compare" value="2005">2005å¹´</div>
                            <div class="sub-option" data-year="2010"><input type="checkbox" name="compare" value="2010">2010å¹´</div>
                            <div class="sub-option" data-year="2015"><input type="checkbox" name="compare" value="2015">2015å¹´</div>
                            <div class="sub-option" data-year="2019"><input type="checkbox" name="compare" value="2019">2019å¹´</div>
                            <div class="sub-option" data-year="2020"><input type="checkbox" name="compare" value="2020">2020å¹´</div>
                        </div>
                    </div>
                    <button id="compare-submit">å¯¹æ¯”</button>
                </div>
            </div>
        </div>
        
        <div id='optionBar'>
            <button id="toggle-sidebar-btn"><<<</button>
            <div id="search-container">
                <input type="text" id="search-box" placeholder="æœç´¢çœä»½">
                <button id="search-btn">æœç´¢</button>
            </div>
            <div class="option" id="compare-btn">å¯¹æ¯”æ¨¡å¼</div>
            <div class="option" id="confirm-btn" style="display:none;">ç¡®è®¤</div>
            <div class="option" data-year="population">äººå£æ™®æŸ¥ (1953-2020) ğŸ‘‡</div>
            <div class="sub-options" id="population-options">
                <div class="sub-option" data-year="1953">1953å¹´</div>
                <div class="sub-option" data-year="1964">1964å¹´</div>
                <div class="sub-option" data-year="1982">1982å¹´</div>
                <div class="sub-option" data-year="1990">1990å¹´</div>
                <div class="sub-option" data-year="2000">2000å¹´</div>
                <div class="sub-option" data-year="2010">2010å¹´</div>
                <div class="sub-option" data-year="2020">2020å¹´</div>
            </div>
            <div class="option" data-year="public_transportation">å…¬å…±äº¤é€šï¼ˆ2020å¹´ï¼‰ğŸ‘‡</div>
            <div class="sub-options" id="transportation-options">
                <div class="sub-option" data-year="bus">å…¬å…±æ±½ç”µè½¦è¿è¥æ•°</div>
                <div class="sub-option" data-year="bus_route">å…¬å…±æ±½ç”µè½¦è¿è¥çº¿è·¯æ€»é•¿åº¦</div>
                <div class="sub-option" data-year="bus_passengers">å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡</div>
                <div class="sub-option" data-year="rail">è½¨é“äº¤é€šè¿è¥æ•°</div>
                <div class="sub-option" data-year="rail_mileage">è½¨é“äº¤é€šè¿è¥é‡Œç¨‹</div>
                <div class="sub-option" data-year="rail_passengers">è½¨é“äº¤é€šè¿è¥æ€»é‡</div>
            </div>
            <div class="option" data-year="urban_facilities">åŸå¸‚è®¾æ–½æ°´å¹³ (2020å¹´)ğŸ‘‡</div>
            <div class="sub-options" id="facilities-options">
                <div class="sub-option" data-year="water">åŸå¸‚ä¾›æ°´æ™®åŠç‡</div>
                <div class="sub-option" data-year="gas">åŸå¸‚ç‡ƒæ°”æ™®åŠç‡</div>
                <div class="sub-option" data-year="trans">æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†</div>
                <div class="sub-option" data-year="road">äººå‡åŸå¸‚é“è·¯é¢ç§¯</div>
                <div class="sub-option" data-year="park">äººå‡å…¬å›­ç»¿åœ°é¢ç§¯</div>
                <div class="sub-option" data-year="wc">æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±å•æ‰€</div>
            </div>
            <div class="option" data-year="water_supply">åŸå¸‚ä¾›æ°´æƒ…å†µ (2020å¹´)ğŸ‘‡</div>
            <div class="sub-options" id="water-supply-options">
                <div class="sub-option" data-year="2020">2020å¹´</div>
            </div>
            <div class="option" data-year="electricity_usage">ç”¨ç”µé‡ (1995-2020å¹´)ğŸ‘‡</div>
            <div class="sub-options" id="electricity-usage-options">
                <div class="sub-option" data-year="1995">1995å¹´</div>
                <div class="sub-option" data-year="2000">2000å¹´</div>
                <div class="sub-option" data-year="2005">2005å¹´</div>
                <div class="sub-option" data-year="2010">2010å¹´</div>
                <div class="sub-option" data-year="2015">2015å¹´</div>
                <div class="sub-option" data-year="2019">2019å¹´</div>
                <div class="sub-option" data-year="2020">2020å¹´</div>
            </div>
        </div>
        <div id='leftview'>
            <div id='topleft'></div>
            <div id='bottomleft'></div>
        </div>
        <div id='rightview'>
            <div id='topright'></div>
            <div id='bottomright'></div>
        </div>
    </main>
    
    <script type='text/javascript'>
        const tooltip = d3.select('body')
            .append('div')
            .attr('class', 'tooltip')
            .style('position', 'absolute')
            .style('z-index', '10') //å±‚çº§
            .style('color', 'black')
            .style('visibility', 'hidden') // ä¸€å¼€å§‹è®¾ç½®ä¸ºä¸å¯è§
            .style('text-anchor', 'middle')
            .style('font-size', '20')
            .text('')
    
        document.addEventListener('DOMContentLoaded', () => {
            let isCompareMode = false;

            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
            toggleSidebarBtn.addEventListener('click', () => {
                optionBar.classList.toggle('collapsed');
                if (optionBar.classList.contains('collapsed')) {
                    toggleSidebarBtn.innerText = '>>>';
                } else {
                    toggleSidebarBtn.innerText = '<<<';
                }
            });


            const searchBox = document.getElementById('search-box');
            const searchBtn = document.getElementById('search-btn');

            searchBtn.addEventListener('click', function () {
                const query = searchBox.value.trim();
                if (query) {
                    searchProvince(query);
                }
            });

            function searchProvince(query) {
                const provinceData = {
                    "åŒ—äº¬": { /* æ•°æ® */ },
                    "ä¸Šæµ·": { /* æ•°æ® */ },
                    // æ·»åŠ å…¶ä»–çœä»½çš„æ•°æ®
                };

                const result = provinceData[query];
                if (result) {
                    displayProvinceData(result);
                } else {
                    alert('æœªæ‰¾åˆ°ç›¸å…³æ•°æ®');
                }
            }

            const compareBtn = document.getElementById('compare-btn');
            const compareModal = document.getElementById('compare-modal');
            const closeModal = document.getElementById('close-modal');
            const compareSubmit = document.getElementById('compare-submit');

            compareBtn.addEventListener('click', function () {
                isCompareMode = !isCompareMode;
                if (isCompareMode) {
                    compareModal.style.display = 'block';
                } else {
                    compareModal.style.display = 'none';
                }
            });

            closeModal.addEventListener('click', function () {
                compareModal.style.display = 'none';
                isCompareMode = false;
                document.querySelectorAll('.sub-option input').forEach(input => input.checked = false);
            });

            compareSubmit.addEventListener('click', function () {
                const selectedOptions = [];
                document.querySelectorAll('.sub-option input:checked').forEach(input => {
                    selectedOptions.push({
                        year: input.value,
                        parent: input.closest('.option').getAttribute('data-year')
                    });
                });

                if (selectedOptions.length === 2) {
                    showComparison(selectedOptions[0], selectedOptions[1]);
                } else {
                    alert("è¯·é€‰æ‹©ä¸¤ä¸ªæ•°æ®é¡¹è¿›è¡Œå¯¹æ¯”ã€‚");
                }
            });

        // å±•å¼€ä¾§è¾¹æ çš„é€‰é¡¹
        document.querySelectorAll('#optionBar .option').forEach(option => {
            option.addEventListener('click', function () {
                document.querySelectorAll('#optionBar .option').forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');
                
                // å…³é—­æ‰€æœ‰å…¶ä»–å­é€‰é¡¹
                document.querySelectorAll('.sub-options').forEach(sub => {
                    if (sub !== this.nextElementSibling) {
                        sub.style.display = 'none';
                    }
                });

                // å±•å¼€å½“å‰å­é€‰é¡¹
                const subOptions = this.nextElementSibling;
                if (subOptions && subOptions.classList.contains('sub-options')) {
                    subOptions.style.display = (subOptions.style.display === 'flex') ? 'none' : 'flex';
                }
            });
        });

        // å±•å¼€å¼¹çª—ä¸­çš„é€‰é¡¹
        document.querySelectorAll('#compare-content .option').forEach(option => {
            option.addEventListener('click', function () {
                const subOptions = this.querySelector('.sub-options');
                if (subOptions) {
                    subOptions.style.display = (subOptions.style.display === 'flex') ? 'none' : 'flex';
                }
            });
        });

        document.querySelectorAll('.sub-option').forEach(option => {
            option.addEventListener('click', function (event) {
                if (isCompareMode) {
                    event.stopPropagation(); // é˜²æ­¢å†’æ³¡ä»¥ä¿æŒcheckboxçš„é€‰ä¸­çŠ¶æ€
                } else {
                    document.querySelectorAll('.sub-option').forEach(opt => opt.classList.remove('active'));
                    this.classList.add('active');
                    const year = this.getAttribute('data-year');
                    const parent = this.parentElement.id;

                    d3.selectAll('svg').remove(); // æ¸…ç©ºä¹‹å‰çš„å¯è§†åŒ–å†…å®¹

                    renderSelection({ year, parent }, 'topleft');
                }
            });
        });

        function showComparison(first, second) {
            compareModal.style.display = 'block';

            const leftComparison = document.getElementById('left-comparison');
            const rightComparison = document.getElementById('right-comparison');
            leftComparison.innerHTML = `<img src="./Resources/heatmap/${first.parent}_${first.year}.png" class="heatmap" alt="${first.parent} ${first.year} çƒ­åŠ›å›¾">`;
            rightComparison.innerHTML = `<img src="./Resources/heatmap/${second.parent}_${second.year}.png" class="heatmap" alt="${second.parent} ${second.year} çƒ­åŠ›å›¾">`;
        }

        function renderSelection(selection, target) {
            const year = selection.year;
            const parent = selection.parent;

            if (parent === 'population-options') {
                renderMap(year, 'population');
                renderline();
                renderCom(year);
                renderbar2('å››å·');
            } else if (parent === 'electricity-usage-options') {
                renderMap(year, 'electricity');
                renderElectricityGrowth();
                renderElectricityAreaChart();
            } else if (parent === 'facilities-options') {
                renderMap(year, 'facilities');
            } else if (parent === 'transportation-options') {
                renderMap(year, 'transportation');
                renderPieForTransportation('å…¨å›½');
                renderTransportationGrowth();
            } else if(parent === 'water-supply-options'){
                renderMap(year, 'water_supply');
                renderPieForWater('å…¨å›½');
                renderBarComplexForWater();
                renderAreaChartForwater();
            }
        }

        function renderComparison(selection, target) {
            const year = selection.year;
            const parent = selection.parent;

            const container = document.getElementById(target);
            container.innerHTML = ""; // æ¸…ç©ºä¹‹å‰çš„å†…å®¹

            const h = document.getElementById(target).clientHeight;
            const w = document.getElementById(target).clientWidth;
            const svg = d3.select(`#${target}`)
                .append('svg')
                .attr('id', `map-${target}`)
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);

            const margin = {
                top: 10,
                left: 10,
                bottom: 10,
                right: 10
            };
            const innerWidth = w - margin.left - margin.right;
            const innerHeight = h - margin.top - margin.bottom;

            const projection = d3.geoMercator()
                .center([103, 39])
                .scale(600)
                .translate([innerWidth / 2, innerHeight / 2]);

            const path = d3.geoPath().projection(projection);

            if (!isNaN(year)) {
                svg.append('g').attr('transform', `translate(${w / 2 - 50},${h / 2 - 185})`)
                    .append('rect')
                    .attr('fill', "#40d8ab")
                    .attr('width', '110')
                    .attr('height', '50');

                svg.append('g').attr('transform', `translate(${w / 2 - 45},${h / 2 - 150})`)
                    .append('text')
                    .attr('fill', '#faf7f4')
                    .attr('font-size', 30)
                    .text(`${year}å¹´`);
            }
        }
    });
        
        renderMap('1953')
        renderline()
        renderCom('1953')
        renderbar2('å››å·')

        function Regional_data_population(province, year, svg, path) {
            d3.csv('./Resources/data/population7.csv').then(function(data) {
                console.log("Population Data:", data);  // æ‰“å°äººå£æ•°æ®
                // è·å–ç‰¹å®šå¹´ä»½çš„äººå£å€¼å¹¶è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹
                let populationValues = data.map(d => {
                    if (year == '1953') return +d.ç¬¬ä¸€æ¬¡äººå£æ™®æŸ¥;
                    else if (year == '1964') return +d.ç¬¬äºŒæ¬¡äººå£æ™®æŸ¥;
                    else if (year == '1982') return +d.ç¬¬ä¸‰æ¬¡äººå£æ™®æŸ¥;
                    else if (year == '1990') return +d.ç¬¬å››æ¬¡äººå£æ™®æŸ¥;
                    else if (year == '2000') return +d.ç¬¬äº”æ¬¡äººå£æ™®æŸ¥;
                    else if (year == '2010') return +d.ç¬¬å…­æ¬¡äººå£æ™®æŸ¥;
                    else if (year == '2020') return +d.ç¬¬ä¸ƒæ¬¡äººå£æ™®æŸ¥;
                }).filter(value => value !== 0); // è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹

                // ç­›é€‰å‡ºpopulationValuesä¸­çš„æœ€å°å€¼å’Œç¬¬äºŒå¤§å€¼
                let minPopulationValue = Math.min(...populationValues);
                let sortedPopulationValues = populationValues.sort((a, b) => b - a);
                let maxPopulationValue = sortedPopulationValues[1]; // è·å–ç¬¬äºŒå¤§å€¼
                console.log("Minimum Population Value:", minPopulationValue);
                console.log("Second Maximum Population Value:", maxPopulationValue);

                // å®šä¹‰è‡ªå®šä¹‰é¢œè‰²æ¯”ä¾‹å°º
                let colorScale = d3.scaleSequential(d3.interpolateReds)
                    .domain([minPopulationValue, maxPopulationValue]);
                d3.json('./Resources/data/china.geojson').then(mapData => {
                    svg.selectAll('path').remove(); // æ¸…ç©ºä¹‹å‰çš„è·¯å¾„

                    svg.selectAll('path')
                        .data(mapData.features)
                        .enter()
                        .append('path')
                        .attr('d', path)
                        .attr('opacity', 0.8)
                        .attr('fill', d => {
                            let regionData = data.find(region => region.åœ°åŒº === d.properties.name);
                            let value = 0;
                            if (regionData) {
                                if (year == '1953') value = +regionData.ç¬¬ä¸€æ¬¡äººå£æ™®æŸ¥;
                                else if (year == '1964') value = +regionData.ç¬¬äºŒæ¬¡äººå£æ™®æŸ¥;
                                else if (year == '1982') value = +regionData.ç¬¬ä¸‰æ¬¡äººå£æ™®æŸ¥;
                                else if (year == '1990') value = +regionData.ç¬¬å››æ¬¡äººå£æ™®æŸ¥;
                                else if (year == '2000') value = +regionData.ç¬¬äº”æ¬¡äººå£æ™®æŸ¥;
                                else if (year == '2010') value = +regionData.ç¬¬å…­æ¬¡äººå£æ™®æŸ¥;
                                else if (year == '2020') value = +regionData.ç¬¬ä¸ƒæ¬¡äººå£æ™®æŸ¥;
                            }
                            return value !== 0 ? colorScale(value) : '#ccc'; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                        })
                        .attr('stroke', '#fff')
                        .attr('stroke-width', 1)
                        .on('mouseenter', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            province = d3.select(this)._groups[0][0].__data__.properties.name;
                            d3.select("#pie").remove();
                            d3.select('#bar2').remove();
                            tooltip.style('visibility', 'visible')
                                .style('left', `${event.pageX + 20}px`)
                                .style('top', `${event.pageY + 20}px`);
                            renderTooltipContent(province, year);
                            renderbar2(province); // é‡æ–°ç»˜åˆ¶æŸ±çŠ¶å›¾
                        })
                        .on('mouseleave', function(d) {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('visibility', 'hidden');
                        });
                });

                
                // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ›´æ–° tooltip å†…å®¹
                function renderTooltipContent(province, year) {
                    for (let i in data) {
                        if (data[i].åœ°åŒº == province) {
                            if (year == '1953')
                                tooltip.text(`${province}æ€»äººå£æ•°:${data[i].ç¬¬ä¸€æ¬¡äººå£æ™®æŸ¥}`);
                            else if (year == '1964')
                                tooltip.text(`${province}æ€»äººå£æ•°:${data[i].ç¬¬äºŒæ¬¡äººå£æ™®æŸ¥}`);
                            else if (year == '1982')
                                tooltip.text(`${province}æ€»äººå£æ•°:${data[i].ç¬¬ä¸‰æ¬¡äººå£æ™®æŸ¥}`);
                            else if (year == '1990')
                                tooltip.text(`${province}æ€»äººå£æ•°:${data[i].ç¬¬å››æ¬¡äººå£æ™®æŸ¥}`);
                            else if (year == '2000')
                                tooltip.text(`${province}æ€»äººå£æ•°:${data[i].ç¬¬äº”æ¬¡äººå£æ™®æŸ¥}`);
                            else if (year == '2010')
                                tooltip.text(`${province}æ€»äººå£æ•°:${data[i].ç¬¬å…­æ¬¡äººå£æ™®æŸ¥}`);
                            else if (year == '2020')
                                tooltip.text(`${province}æ€»äººå£æ•°:${data[i].ç¬¬ä¸ƒæ¬¡äººå£æ™®æŸ¥}`);
                            break;
                        }
                    }
                }
            });
        }

        function Regional_data_electricity(province, year, svg, path) {
            d3.csv('./Resources/data/electricity_usage.csv').then(function(data) {
                console.log("Electricity Data:", data);  // æ‰“å°ç”µåŠ›æ•°æ®
                // è·å–ç‰¹å®šå¹´ä»½çš„ç”µåŠ›å€¼å¹¶è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹
                let electricityValues = data.map(d => {
                    if (year == '1995') return +d['1995'];
                    else if (year == '2000') return +d['2000'];
                    else if (year == '2005') return +d['2005'];
                    else if (year == '2010') return +d['2010'];
                    else if (year == '2015') return +d['2015'];
                    else if (year == '2019') return +d['2019'];
                    else if (year == '2020') return +d['2020'];
                }).filter(value => value !== 0); // è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹

                // ç­›é€‰å‡ºelectricityValuesä¸­çš„æœ€å°å€¼å’Œç¬¬äºŒå¤§å€¼
                let minElectricityValue = Math.min(...electricityValues);
                let sortedElectricityValues = electricityValues.sort((a, b) => b - a);
                let maxElectricityValue = sortedElectricityValues[1]; // è·å–ç¬¬äºŒå¤§å€¼
                console.log("Minimum Electricity Value:", minElectricityValue);
                console.log("Second Maximum Electricity Value:", maxElectricityValue);

                // å®šä¹‰è‡ªå®šä¹‰é¢œè‰²æ¯”ä¾‹å°º
                let colorScale = d3.scaleSequential(d3.interpolateYlOrBr)
                    .domain([minElectricityValue, maxElectricityValue]);
                d3.json('./Resources/data/china.geojson').then(mapData => {
                    svg.selectAll('path').remove(); // æ¸…ç©ºä¹‹å‰çš„è·¯å¾„

                    svg.selectAll('path')
                        .data(mapData.features)
                        .enter()
                        .append('path')
                        .attr('d', path)
                        .attr('opacity', 0.8)
                        .attr('fill', d => {
                            let regionData = data.find(region => region.åœ°åŒº === d.properties.name);
                            let value = 0;
                            if (regionData) {
                                if (year == '1995') value = +regionData['1995'];
                                else if (year == '2000') value = +regionData['2000'];
                                else if (year == '2005') value = +regionData['2005'];
                                else if (year == '2010') value = +regionData['2010'];
                                else if (year == '2015') value = +regionData['2015'];
                                else if (year == '2019') value = +regionData['2019'];
                                else if (year == '2020') value = +regionData['2020'];
                            }
                            return value !== 0 ? colorScale(value) : '#ccc'; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                        })
                        .attr('stroke', '#fff')
                        .attr('stroke-width', 1)
                        .on('mouseenter', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            province = d3.select(this)._groups[0][0].__data__.properties.name;
                            d3.select("#pie").remove();
                            d3.select('#bar2').remove();
                            tooltip.style('visibility', 'visible')
                                .style('left', `${event.pageX + 20}px`)
                                .style('top', `${event.pageY + 20}px`);
                            renderTooltipContent(province, year);
                            draw_electricity_LineChart(province); // é‡æ–°ç»˜åˆ¶æŸ±çŠ¶å›¾
                        })
                        .on('mouseleave', function(d) {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('visibility', 'hidden');
                        });
                });

                // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ›´æ–° tooltip å†…å®¹
                function renderTooltipContent(province, year) {
                    for (let i in data) {
                        if (data[i].åœ°åŒº == province) {
                            if (year == '1995')
                                tooltip.text(`${province}æ€»ç”¨ç”µé‡:${data[i]['1995']} äº¿åƒç“¦æ—¶`);
                            else if (year == '2000')
                                tooltip.text(`${province}æ€»ç”¨ç”µé‡:${data[i]['2000']} äº¿åƒç“¦æ—¶`);
                            else if (year == '2005')
                                tooltip.text(`${province}æ€»ç”¨ç”µé‡:${data[i]['2005']} äº¿åƒç“¦æ—¶`);
                            else if (year == '2010')
                                tooltip.text(`${province}æ€»ç”¨ç”µé‡:${data[i]['2010']} äº¿åƒç“¦æ—¶`);
                            else if (year == '2015')
                                tooltip.text(`${province}æ€»ç”¨ç”µé‡:${data[i]['2015']} äº¿åƒç“¦æ—¶`);
                            else if (year == '2019')
                                tooltip.text(`${province}æ€»ç”¨ç”µé‡:${data[i]['2019']} äº¿åƒç“¦æ—¶`);
                            else if (year == '2020')
                                tooltip.text(`${province}æ€»ç”¨ç”µé‡:${data[i]['2020']} äº¿åƒç“¦æ—¶`);
                            break;
                        }
                    }
                }
            });
        }

        function Regional_data_transportation(province, metric, svg, path) {
            d3.csv('./Resources/data/public_transportation.csv').then(function(data) {
                console.log("Transportation Data:", data);  // æ‰“å°å…¬å…±äº¤é€šæ•°æ®

                // è·å–ç‰¹å®šäº¤é€šæŒ‡æ ‡çš„å€¼å¹¶è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹
                let transportationValues = data.map(d => {
                    if (metric === 'bus') return +d['å…¬å…±æ±½ç”µè½¦è¿è¥æ•°'];
                    else if (metric === 'bus_route') return +d['è¿è¥çº¿è·¯æ€»é•¿åº¦'];
                    else if (metric === 'bus_passengers') return +d['å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡'];
                    else if (metric === 'rail') return +d['è½¨é“äº¤é€šè¿è¥æ•°'];
                    else if (metric === 'rail_mileage') return +d['è½¨é“äº¤é€šè¿è¥é‡Œç¨‹'];
                    else if (metric === 'rail_passengers') return +d['è½¨é“äº¤é€šå®¢è¿æ€»é‡'];
                }).filter(value => value !== 0); // è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹

                // ç­›é€‰å‡ºtransportationValuesä¸­çš„æœ€å°å€¼å’Œç¬¬äºŒå¤§å€¼
                let minTransportationValue = Math.min(...transportationValues);
                let sortedTransportationValues = transportationValues.sort((a, b) => b - a);
                let secondMaxTransportationValue = sortedTransportationValues[1]; // è·å–ç¬¬äºŒå¤§å€¼
                console.log("Minimum Transportation Value:", minTransportationValue);
                console.log("Second Maximum Transportation Value:", secondMaxTransportationValue);

                // å®šä¹‰è‡ªå®šä¹‰é¢œè‰²æ¯”ä¾‹å°º
                let colorScale = d3.scaleSequential(d3.interpolateOranges)
                    .domain([minTransportationValue, secondMaxTransportationValue]);
                
                d3.json('./Resources/data/china.geojson').then(mapData => {
                    svg.selectAll('path').remove(); // æ¸…ç©ºä¹‹å‰çš„è·¯å¾„

                    svg.selectAll('path')
                        .data(mapData.features)
                        .enter()
                        .append('path')
                        .attr('d', path)
                        .attr('opacity', 0.8)
                        .attr('fill', d => {
                            let regionData = data.find(region => region.åœ°åŒº === d.properties.name);
                            let value = 0;
                            if (regionData) {
                                if (metric === 'bus') value = +regionData['å…¬å…±æ±½ç”µè½¦è¿è¥æ•°'];
                                else if (metric === 'bus_route') value = +regionData['è¿è¥çº¿è·¯æ€»é•¿åº¦'];
                                else if (metric === 'bus_passengers') value = +regionData['å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡'];
                                else if (metric === 'rail') value = +regionData['è½¨é“äº¤é€šè¿è¥æ•°'];
                                else if (metric === 'rail_mileage') value = +regionData['è½¨é“äº¤é€šè¿è¥é‡Œç¨‹'];
                                else if (metric === 'rail_passengers') value = +regionData['è½¨é“äº¤é€šå®¢è¿æ€»é‡'];
                            }
                            return value !== 0 ? colorScale(value) : '#ccc'; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                        })
                        .attr('stroke', '#fff')
                        .attr('stroke-width', 1)
                        .on('mouseenter', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            province = d3.select(this)._groups[0][0].__data__.properties.name;
                            tooltip.style('visibility', 'visible')
                                .style('left', `${event.pageX + 20}px`)
                                .style('top', `${event.pageY + 20}px`);
                            renderTooltipContent(province, metric);
                            renderPieForTransportation(province);
                        })
                        .on('mouseleave', function(d) {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('visibility', 'hidden');
                        });
                });

                // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ›´æ–° tooltip å†…å®¹
                function renderTooltipContent(province, metric) {
                    for (let i in data) {
                        if (data[i].åœ°åŒº == province) {
                            if (metric === 'bus')
                                tooltip.text(`${province}å…¬å…±æ±½ç”µè½¦è¿è¥æ•°: ${data[i]['å…¬å…±æ±½ç”µè½¦è¿è¥æ•°']}`);
                            else if (metric === 'bus_route')
                                tooltip.text(`${province}å…¬å…±æ±½ç”µè½¦è¿è¥çº¿è·¯æ€»é•¿åº¦: ${data[i]['è¿è¥çº¿è·¯æ€»é•¿åº¦']} å…¬é‡Œ`);
                            else if (metric === 'bus_passengers')
                                tooltip.text(`${province}å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡: ${data[i]['å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡']} ä¸‡äººæ¬¡`);
                            else if (metric === 'rail')
                                tooltip.text(`${province}è½¨é“äº¤é€šè¿è¥æ•°: ${data[i]['è½¨é“äº¤é€šè¿è¥æ•°']}`);
                            else if (metric === 'rail_mileage')
                                tooltip.text(`${province}è½¨é“äº¤é€šè¿è¥é‡Œç¨‹: ${data[i]['è½¨é“äº¤é€šè¿è¥é‡Œç¨‹']} å…¬é‡Œ`);
                            else if (metric === 'rail_passengers')
                                tooltip.text(`${province}è½¨é“äº¤é€šå®¢è¿æ€»é‡: ${data[i]['è½¨é“äº¤é€šå®¢è¿æ€»é‡']} ä¸‡äººæ¬¡`);
                            break;
                        }
                    }
                }
            });
        }

        function draw_electricity_LineChart(province) {
            // å›ºå®šç»˜å›¾å¤§å°
            const width = 400;
            const height = 400;
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };

            // ç§»é™¤ä¹‹å‰çš„SVGå®¹å™¨å’Œæ‰€æœ‰å­å…ƒç´ 
            d3.select('#topright').selectAll('svg').remove();

            // åˆ›å»ºæ–°çš„SVGå®¹å™¨
            const svg = d3.select('#topright')
                .append('svg')
                .attr('id', 'line') // è®¾ç½®SVGçš„IDä¸ºline
                .attr('width', width + margin.left + margin.right) // è®¾ç½®SVGå®½åº¦
                .attr('height', height + margin.top + margin.bottom); // è®¾ç½®SVGé«˜åº¦

            // æ·»åŠ æ•°æ®
            d3.csv('./Resources/data/electricity_usage.csv').then(function(data) {
                const years = Object.keys(data[0]).filter(key => key !== 'åœ°åŒº'); // è·å–æ‰€æœ‰å¹´ä»½

                const provinceData = data.find(d => d.åœ°åŒº === province); // æ‰¾åˆ°æŒ‡å®šçœä»½çš„æ•°æ®

                const provinceDataArray = years.map(year => +provinceData[year]); // è·å–æŒ‡å®šçœä»½çš„æ¯å¹´æ•°æ®

                // å®šä¹‰Xè½´æ¯”ä¾‹å°º
                const xScale = d3.scaleBand()
                    .domain(years)
                    .range([0, width])
                    .padding(0.1);

                // å®šä¹‰Yè½´æ¯”ä¾‹å°º
                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(provinceDataArray)])
                    .range([height, 0]);

                // ç»˜åˆ¶æŠ˜çº¿è·¯å¾„
                svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`)
                    .selectAll(".line")
                    .data([provinceDataArray])
                    .enter().append("path")
                    .attr("class", "line")
                    .attr("fill", "none")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 2)
                    .attr("d", d3.line()
                        .x((d, i) => xScale(years[i]) + xScale.bandwidth() / 2)
                        .y(d => yScale(d))
                        .curve(d3.curveMonotoneX)
                    );

                // æ·»åŠ Xè½´
                svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${height + margin.top})`)
                    .call(d3.axisBottom(xScale).tickSize(0))
                    .selectAll("text")
                    .style("text-anchor", "middle")
                    .attr("dy", "1em");

                // æ·»åŠ Yè½´
                svg.append('g')
                    .attr('transform', `translate(${margin.left}, ${margin.top})`)
                    .call(d3.axisLeft(yScale).ticks(5).tickSize(0))
                    .selectAll(".tick line")
                    .attr("stroke", "#ddd");

                // æ·»åŠ Xè½´æ ‡ç­¾
                svg.append('text')
                    .attr('transform', `translate(${margin.left + width / 2}, ${height + margin.top + 30})`)
                    .style('text-anchor', 'middle')
                    .text('å¹´ä»½');

                // æ·»åŠ Yè½´æ ‡ç­¾
                svg.append('text')
                    .attr('transform', `translate(${margin.left - 40}, ${margin.top + height / 2}) rotate(-90)`)
                    .attr('dy', '1em')
                    .style('text-anchor', 'middle')
                    .text('ç”¨ç”µé‡ (äº¿åƒç“¦æ—¶)');

                // æ·»åŠ æ•°æ®æ ‡ç­¾
                svg.selectAll("text.label")
                    .data(provinceDataArray)
                    .enter().append("text")
                    .attr("class", "label")
                    .attr("x", (d, i) => xScale(years[i]) + xScale.bandwidth() / 2 + margin.left)
                    .attr("y", d => yScale(d) - 10 + margin.top)
                    .attr("text-anchor", "middle")
                    .text(d => d.toFixed(2));

                // æ·»åŠ æ ‡é¢˜
                svg.append('text')
                    .attr('x', margin.left + width / 2)
                    .attr('y', margin.top - 10)
                    .attr('text-anchor', 'middle')
                    .style('font-size', '16px')
                    .text(`${province} ç”¨ç”µé‡æŠ˜çº¿å›¾`);
            });
        }



        function Regional_data_urban_facilities(province, facility, svg, path) {
            d3.csv('./Resources/data/urban_facilities.csv').then(function(data) {
                console.log("Urban Facilities Data:", data);  // æ‰“å°åŸå¸‚è®¾æ–½æƒ…å†µæ•°æ®

                // è·å–ç‰¹å®šè®¾æ–½çš„å€¼å¹¶è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹
                let facilityValues = data.map(d => {
                    if (facility === 'water') return +d['åŸå¸‚ä¾›æ°´æ™®åŠç‡(%)'];
                    else if (facility === 'gas') return +d['åŸå¸‚ç‡ƒæ°”æ™®åŠç‡(%)'];
                    else if (facility === 'trans') return +d['æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†(æ ‡å°)'];
                    else if (facility === 'road') return +d['äººå‡åŸå¸‚é“è·¯é¢ç§¯(å¹³æ–¹ç±³)'];
                    else if (facility === 'park') return +d['äººå‡å…¬å›­ç»¿åœ°é¢ç§¯(å¹³æ–¹ç±³)'];
                    else if (facility === 'wc') return +d['æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±å•æ‰€(åº§)'];
                }).filter(value => value !== 0); // è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹

                // ç­›é€‰å‡ºfacilityValuesä¸­çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
                let minFacilityValue = Math.min(...facilityValues);
                let maxFacilityValue = Math.max(...facilityValues);
                console.log("Minimum Facility Value:", minFacilityValue);
                console.log("Maximum Facility Value:", maxFacilityValue);

                // å®šä¹‰è‡ªå®šä¹‰é¢œè‰²æ¯”ä¾‹å°º
                let colorScale = d3.scaleSequential(d3.interpolateGreens)
                    .domain([minFacilityValue, maxFacilityValue]);
                
                d3.json('./Resources/data/china.geojson').then(mapData => {
                    svg.selectAll('path').remove(); // æ¸…ç©ºä¹‹å‰çš„è·¯å¾„

                    svg.selectAll('path')
                        .data(mapData.features)
                        .enter()
                        .append('path')
                        .attr('d', path)
                        .attr('opacity', 0.8)
                        .attr('fill', d => {
                            let regionData = data.find(region => region.åœ°åŒº === d.properties.name);
                            let value = 0;
                            if (regionData) {
                                if (facility === 'water') value = +regionData['åŸå¸‚ä¾›æ°´æ™®åŠç‡(%)'];
                                else if (facility === 'gas') value = +regionData['åŸå¸‚ç‡ƒæ°”æ™®åŠç‡(%)'];
                                else if (facility === 'trans') value = +regionData['æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†(æ ‡å°)'];
                                else if (facility === 'road') value = +regionData['äººå‡åŸå¸‚é“è·¯é¢ç§¯(å¹³æ–¹ç±³)'];
                                else if (facility === 'park') value = +regionData['äººå‡å…¬å›­ç»¿åœ°é¢ç§¯(å¹³æ–¹ç±³)'];
                                else if (facility === 'wc') value = +regionData['æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±å•æ‰€(åº§)'];
                            }
                            return value !== 0 ? colorScale(value) : '#ccc'; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                        })
                        .attr('stroke', '#fff')
                        .attr('stroke-width', 1)
                        .on('mouseenter', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            province = d3.select(this)._groups[0][0].__data__.properties.name;
                            tooltip.style('visibility', 'visible')
                                .style('left', `${event.pageX + 20}px`)
                                .style('top', `${event.pageY + 20}px`);
                            renderTooltipContent(province, facility);
                            d3.select("#Facilities_bar").remove(); // æ¸…é™¤ä¹‹å‰çš„æŸ±çŠ¶å›¾
                            d3.select("#Facilities_scatter").remove();
                            Urban_Facilities_bar(province);
                            Urban_Facilities_scatter(province);
                        })
                        .on('mouseleave', function(d) {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('visibility', 'hidden');
                        });
                });

                // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ›´æ–° tooltip å†…å®¹
                function renderTooltipContent(province, facility) {
                    for (let i in data) {
                        if (data[i].åœ°åŒº == province) {
                            let facilitiesText = `${province}åŸå¸‚è®¾æ–½:\n`;
                            if (facility === 'water') {
                                facilitiesText += `åŸå¸‚ä¾›æ°´æ™®åŠç‡(%): ${data[i]['åŸå¸‚ä¾›æ°´æ™®åŠç‡(%)']}`;
                            } else if (facility === 'gas') {
                                facilitiesText += `åŸå¸‚ç‡ƒæ°”æ™®åŠç‡(%): ${data[i]['åŸå¸‚ç‡ƒæ°”æ™®åŠç‡(%)']}`;
                            } else if (facility === 'trans') {
                                facilitiesText += `æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†(æ ‡å°): ${data[i]['æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†(æ ‡å°)']}`;
                            } else if (facility === 'road') {
                                facilitiesText += `äººå‡åŸå¸‚é“è·¯é¢ç§¯(å¹³æ–¹ç±³): ${data[i]['äººå‡åŸå¸‚é“è·¯é¢ç§¯(å¹³æ–¹ç±³)']}`;
                            } else if (facility === 'park') {
                                facilitiesText += `äººå‡å…¬å›­ç»¿åœ°é¢ç§¯(å¹³æ–¹ç±³): ${data[i]['äººå‡å…¬å›­ç»¿åœ°é¢ç§¯(å¹³æ–¹ç±³)']}`;
                            } else if (facility === 'wc') {
                                facilitiesText += `æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±å•æ‰€(åº§): ${data[i]['æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±å•æ‰€(åº§)']}`;
                            }
                            tooltip.text(facilitiesText);
                            break;
                        }
                    }
                }
            });
        }

        function Regional_data_water_supply(province, year, svg, path) {
            d3.csv('./Resources/data/water_supply.csv').then(function(data) {
                console.log("Water Supply Data:", data);  // æ‰“å°ä¾›æ°´æ•°æ®
                // è·å–å…¨å¹´ä¾›æ°´æ€»é‡çš„å€¼å¹¶è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹
                let waterSupplyValues = data.map(d => +d['å…¨å¹´ä¾›æ°´æ€»é‡(ä¸‡ç«‹æ–¹ç±³)']).filter(value => value !== 0); // è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹

                // ç­›é€‰å‡ºwaterSupplyValuesä¸­çš„æœ€å°å€¼å’Œç¬¬äºŒå¤§å€¼
                let minWaterSupplyValue = Math.min(...waterSupplyValues);
                let sortedWaterSupplyValues = waterSupplyValues.sort((a, b) => b - a);
                let maxWaterSupplyValue = sortedWaterSupplyValues[1]; // è·å–ç¬¬äºŒå¤§å€¼
                console.log("Minimum Water Supply Value:", minWaterSupplyValue);
                console.log("Second Maximum Water Supply Value:", maxWaterSupplyValue);

                // å®šä¹‰è‡ªå®šä¹‰é¢œè‰²æ¯”ä¾‹å°º
                let colorScale = d3.scaleSequential(d3.interpolateBlues)
                    .domain([minWaterSupplyValue, maxWaterSupplyValue]);
                d3.json('./Resources/data/china.geojson').then(mapData => {
                    svg.selectAll('path').remove(); // æ¸…ç©ºä¹‹å‰çš„è·¯å¾„

                    svg.selectAll('path')
                        .data(mapData.features)
                        .enter()
                        .append('path')
                        .attr('d', path)
                        .attr('opacity', 0.8)
                        .attr('fill', d => {
                            let regionData = data.find(region => region.åœ°åŒº === d.properties.name);
                            let value = 0;
                            if (regionData) {
                                value = +regionData['å…¨å¹´ä¾›æ°´æ€»é‡(ä¸‡ç«‹æ–¹ç±³)'];
                            }
                            return value !== 0 ? colorScale(value) : '#ccc'; // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                        })
                        .attr('stroke', '#fff')
                        .attr('stroke-width', 1)
                        .on('mouseenter', function(event, d) {
                            d3.select(this).attr('opacity', 1);
                            province = d3.select(this)._groups[0][0].__data__.properties.name;
                            d3.select("#pie").remove();
                            d3.select('#bar2').remove();
                            tooltip.style('visibility', 'visible')
                                .style('left', `${event.pageX + 20}px`)
                                .style('top', `${event.pageY + 20}px`);
                            renderTooltipContent(province, year);
                            renderPieForWater(province); // é‡æ–°ç»˜åˆ¶æŸ±çŠ¶å›¾
                        })
                        .on('mouseleave', function(d) {
                            d3.select(this).attr('opacity', 0.8);
                            tooltip.style('visibility', 'hidden');
                        });
                });

                // å®šä¹‰ä¸€ä¸ªå‡½æ•°æ¥æ›´æ–° tooltip å†…å®¹
                function renderTooltipContent(province, year) {
                    for (let i in data) {
                        if (data[i].åœ°åŒº == province) {
                            tooltip.text(`${province}å…¨å¹´ä¾›æ°´æ€»é‡:${data[i]['å…¨å¹´ä¾›æ°´æ€»é‡(ä¸‡ç«‹æ–¹ç±³)']} ä¸‡ç«‹æ–¹ç±³`);
                            break;
                        }
                    }
                }
            });
        }

        //ç»˜åˆ¶äº¤é€šé¥¼çŠ¶å›¾
        function renderPieForTransportation(province) {
            const h = document.getElementById('topright').clientHeight;
            const w = document.getElementById('topright').clientWidth;
            // ç§»é™¤ä¹‹å‰çš„é¥¼å›¾
            d3.select('#rose').remove();
            const svg = d3.select('#topright')
                .append('svg')
                .attr('id', 'rose')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);

            d3.csv('./Resources/data/public_transportation.csv').then(function(data) {
                for (let i in data) {
                    if (data[i].åœ°åŒº == province) {
                        const pie = d3.pie()
                            .value(d => d.value)
                            .sort(null)
                            .padAngle(0.02);

                        const color = d3.scaleOrdinal(d3.schemeCategory10);
                        const length = 2; // åœ†å¼§æ•°é‡
                        const pieData = [data[i].å…¬å…±æ±½ç”µè½¦è¿è¥æ•°, data[i].è½¨é“äº¤é€šè¿è¥æ•°];
                        const sum = d3.sum(pieData);
                        const dataset1 = [{
                            name: `å…¬å…±æ±½ç”µè½¦è¿è¥æ•°`,
                            value: data[i].å…¬å…±æ±½ç”µè½¦è¿è¥æ•°,
                            ratio: `${Math.round((+data[i].å…¬å…±æ±½ç”µè½¦è¿è¥æ•°) / (+sum) * 10000) / 100}%`
                        }, {
                            name: `è½¨é“äº¤é€šè¿è¥æ•°`,
                            value: data[i].è½¨é“äº¤é€šè¿è¥æ•°,
                            ratio: `${Math.round((+data[i].è½¨é“äº¤é€šè¿è¥æ•°) / (+sum) * 10000) / 100}%`
                        }];

                        const color1 = ['#d73027', '#fc8d59']; // ä½¿ç”¨çº¢è‰²ç›¸å…³çš„é¢œè‰²
                        const RoseChart1 = svg.append('g')
                            .attr('transform', 'translate(250,200)'); // å‘å³ç§»åŠ¨å¹¶ç¨å¾®æ”¾å¤§é¥¼å›¾ä½ç½®
                        const pie_data1 = pie(dataset1);

                        const arc1 = d3.arc()
                            .outerRadius(120) // ç¨å¾®æ”¾å¤§é¥¼å›¾
                            .innerRadius(60)
                            .cornerRadius(5);

                        const slices1 = RoseChart1.selectAll('path')
                            .data(pie_data1)
                            .enter()
                            .append('path')
                            .attr('fill', function(d, i) {
                                return color1[d.index];
                            })
                            .attr('d', d => arc1(d));

                        const label1 = RoseChart1.selectAll('text')
                            .data(pie_data1)
                            .enter()
                            .append('text')
                            .attr('fill', 'black')
                            .attr('transform', d => `translate(${arc1.centroid(d)})`) // è®¡ç®—å¹³é¢è´¨å¿ƒä½ç½®
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.ratio);

                        const tips1 = svg.append('g')
                            .attr('transform', 'translate(50,40)');
                        const tip1 = tips1.selectAll('rect')
                            .data(pie_data1)
                            .enter()
                            .append('rect')
                            .attr('fill', function(d, i) {
                                return color1[i];
                            })
                            .attr('width', '150') // æ‹“å®½å›¾ä¾‹
                            .attr('height', '50')
                            .attr('transform', (d, i) => {
                                let translate = [i * 150, 0]; // è°ƒæ•´é—´è·
                                return 'translate(' + translate + ')';
                            });

                        const tip_text1 = svg.append('g').attr('transform', 'translate(125,60)').selectAll('text')
                            .data(pie_data1)
                            .enter()
                            .append('text')
                            .attr('fill', 'white')
                            .attr('transform', (d, i) => {
                                let translate = [i * 150, 0]; // è°ƒæ•´é—´è·
                                return 'translate(' + translate + ')';
                            })
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.name);

                        svg.append('g').attr('transform', `translate(${w/3  - 100},30)`) // ç¼©å°å¹¶ä¸Šç§»æ ‡é¢˜ä½ç½®
                            .append('text')
                            .attr('fill', 'black')
                            .attr('font-size', 20) // ç¼©å°æ ‡é¢˜
                            .text(`è¿è¥æ¨¡å¼æƒ…å†µ`);
                        break;
                    }
                }
            });
        }

        function renderBarComplexForWater(){
            const h = document.getElementById('topleft').clientHeight;
            const w = document.getElementById('topleft').clientWidth;
            const svg = d3.select('#topleft')
                .append('svg')
                .attr('id', 'electricity_growth')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);

            d3.csv('/Resources/data/water_supply.csv').then(function(data) {
                data = data.filter(d => d.åœ°åŒº !== "å…¨å›½");

                const regions = Array.from(new Set(data.map(d => d.åœ°åŒº)));

                // é‡ç»„æ•°æ®ä»¥é€‚åº”å †å å›¾æ ¼å¼
                const formattedData = regions.map(region => {
                    const regionData = data.find(d => d.åœ°åŒº === region);
                    return {
                        åœ°åŒº: region,
                        ç”Ÿæ´»ç”¨æ°´: +regionData.ç”Ÿæ´»ç”¨æ°´,
                        ç”Ÿäº§ç”¨æ°´: +regionData.ç”Ÿäº§ç”¨æ°´
                    };
                });

                const stack = d3.stack()
                    .keys(['ç”Ÿæ´»ç”¨æ°´', 'ç”Ÿäº§ç”¨æ°´']);

                const stackedData = stack(formattedData);

                const xScale = d3.scaleBand()
                    .domain(regions)
                    .range([0, w - 350])  // è°ƒæ•´å®½åº¦ä»¥ç•™å‡ºç©ºé—´æ”¾ç½®å›¾ä¾‹
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(stackedData[stackedData.length - 1], d => d[1])])
                    .range([h - 100, 0])
                    .nice();

                const color = d3.scaleOrdinal()
                    .domain(['ç”Ÿæ´»ç”¨æ°´', 'ç”Ÿäº§ç”¨æ°´'])
                    .range(['#1f77b4', '#2ca02c']);

                const g = svg.append('g')
                    .attr('transform', `translate(50, 50)`);

                const groups = g.selectAll('g')
                    .data(stackedData)
                    .enter()
                    .append('g')
                    .attr('fill', d => color(d.key));

                groups.selectAll('rect')
                    .data(d => d)
                    .enter()
                    .append('rect')
                    .attr('x', d => xScale(d.data.åœ°åŒº))
                    .attr('y', d => yScale(d[1]))
                    .attr('height', d => yScale(d[0]) - yScale(d[1]))
                    .attr('width', xScale.bandwidth());

                const xAxis = d3.axisBottom(xScale);
                const yAxis = d3.axisLeft(yScale).ticks(10);

                g.append('g')
                    .attr('transform', `translate(0, ${h - 100})`)
                    .call(xAxis)
                    .selectAll('text')
                    .attr('transform', 'rotate(-40)')
                    .style('text-anchor', 'end');

                g.append('g').call(yAxis);

                svg.append('g')
                    .attr('transform', `translate(${w / 2 -250}, 30)`)
                    .append('text')
                    .attr('fill', 'black')
                    .attr('font-size', 20)
                    .text(`å„åœ°åŒºç”Ÿäº§ç”¨æ°´å’Œç”Ÿæ´»ç”¨æ°´åˆ†æ`);

                // æ·»åŠ å›¾ä¾‹
                const legend = svg.append('g')
                    .attr('transform', `translate(${w - 400}, 50)`); // å°†å›¾ä¾‹æ”¾åœ¨å³ä¾§

                const legendData = [
                    {name: 'ç”Ÿæ´»ç”¨æ°´(ä¸‡ç«‹æ–¹ç±³)', color: '#1f77b4'},
                    {name: 'ç”Ÿäº§ç”¨æ°´(ä¸‡ç«‹æ–¹ç±³)', color: '#2ca02c'}
                ];

                legendData.forEach((d, i) => {
                    const legendRow = legend.append('g')
                        .attr('transform', `translate(0, ${i * 20})`);

                    legendRow.append('rect')
                        .attr('width', 10)
                        .attr('height', 10)
                        .attr('fill', d.color);

                    legendRow.append('text')
                        .attr('x', 20)
                        .attr('y', 10)
                        .attr('text-anchor', 'start')
                        .style('text-transform', 'capitalize')
                        .text(d.name);
                });
            });
        }

         //è½¨é“äº¤é€šå„åŸå¸‚å®¢è¿é‡æƒ…å†µç»Ÿè®¡
         function renderTransportationGrowth() {
            const h = document.getElementById('topleft').clientHeight;
            const w = document.getElementById('topleft').clientWidth;
            const svg = d3.select('#topleft')
                .append('svg')
                .attr('id', 'electricity_growth')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);

            d3.csv('/Resources/data/public_transportation.csv').then(function(data) {
                data = data.filter(d => d.åœ°åŒº !== "å…¨å›½");

                const regions = Array.from(new Set(data.map(d => d.åœ°åŒº)));

                // é‡ç»„æ•°æ®ä»¥é€‚åº”å †å å›¾æ ¼å¼
                const formattedData = regions.map(region => {
                    const regionData = data.find(d => d.åœ°åŒº === region);
                    return {
                        åœ°åŒº: region,
                        å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡: +regionData.å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡,
                        è½¨é“äº¤é€šå®¢è¿æ€»é‡: +regionData.è½¨é“äº¤é€šå®¢è¿æ€»é‡
                    };
                });

                const stack = d3.stack()
                    .keys(['å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡', 'è½¨é“äº¤é€šå®¢è¿æ€»é‡']);

                const stackedData = stack(formattedData);

                const xScale = d3.scaleBand()
                    .domain(regions)
                    .range([0, w - 200])  // è°ƒæ•´å®½åº¦ä»¥ç•™å‡ºç©ºé—´æ”¾ç½®å›¾ä¾‹
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(stackedData[stackedData.length - 1], d => d[1])])
                    .range([h - 100, 0])
                    .nice();

                const color = d3.scaleOrdinal()
                    .domain(['å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡', 'è½¨é“äº¤é€šå®¢è¿æ€»é‡'])
                    .range(['#d73027', '#fc8d59']);

                const g = svg.append('g')
                    .attr('transform', `translate(50, 50)`);

                const groups = g.selectAll('g')
                    .data(stackedData)
                    .enter()
                    .append('g')
                    .attr('fill', d => color(d.key));

                groups.selectAll('rect')
                    .data(d => d)
                    .enter()
                    .append('rect')
                    .attr('x', d => xScale(d.data.åœ°åŒº))
                    .attr('y', d => yScale(d[1]))
                    .attr('height', d => yScale(d[0]) - yScale(d[1]))
                    .attr('width', xScale.bandwidth());

                const xAxis = d3.axisBottom(xScale);
                const yAxis = d3.axisLeft(yScale).ticks(10);

                g.append('g')
                    .attr('transform', `translate(0, ${h - 100})`)
                    .call(xAxis)
                    .selectAll('text')
                    .attr('transform', 'rotate(-40)')
                    .style('text-anchor', 'end');

                g.append('g').call(yAxis);

                svg.append('g')
                    .attr('transform', `translate(${w / 2}, 30)`)
                    .append('text')
                    .attr('fill', 'black')
                    .attr('font-size', 20)
                    .text(`å„åœ°åŒºå®¢è¿æ€»é‡åˆ†æ`);

                // æ·»åŠ å›¾ä¾‹
                const legend = svg.append('g')
                    .attr('transform', `translate(${w - 300}, 50)`); // å°†å›¾ä¾‹æ”¾åœ¨å³ä¾§

                const legendData = [
                    {name: 'å…¬å…±æ±½ç”µè½¦å®¢è¿æ€»é‡(ä¸‡äººæ¬¡)', color: '#d73027'},
                    {name: 'è½¨é“äº¤é€šå®¢è¿æ€»é‡(ä¸‡äººæ¬¡)', color: '#fc8d59'}
                ];

                legendData.forEach((d, i) => {
                    const legendRow = legend.append('g')
                        .attr('transform', `translate(0, ${i * 20})`);

                    legendRow.append('rect')
                        .attr('width', 10)
                        .attr('height', 10)
                        .attr('fill', d.color);

                    legendRow.append('text')
                        .attr('x', 20)
                        .attr('y', 10)
                        .attr('text-anchor', 'start')
                        .style('text-transform', 'capitalize')
                        .text(d.name);
                });
            });
        }

        function renderElectricityAreaChart() {
            const h = document.getElementById('bottomright').clientHeight; // è·å–å³ä¸‹è§’å®¹å™¨é«˜åº¦
            const w = document.getElementById('bottomright').clientWidth; // è·å–å³ä¸‹è§’å®¹å™¨å®½åº¦
            const svg = d3.select('#bottomright') // ä¿®æ”¹é€‰æ‹©å™¨ä¸ºå³ä¸‹è§’å®¹å™¨
                .append('svg')
                .attr('id', 'electricity_area_chart')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);

            d3.csv('/Resources/data/electricity_usage.csv').then(function(data) {
                data = data.filter(d => d.åœ°åŒº !== "æ€»ç”¨ç”µé‡");
                const years = ['1995', '2000', '2005', '2010', '2015', '2019', '2020'];
                const regions = Array.from(new Set(data.map(d => d.åœ°åŒº)));

                const stackedData = d3.stack()
                    .keys(years)
                    .value((d, key) => +d[key])
                    .offset(d3.stackOffsetNone)
                    (data);

                const xScale = d3.scaleBand()
                    .domain(regions)
                    .range([0, w - 100]) // å°†å®½åº¦æ”¹ä¸º w - 100
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(stackedData, d => d3.max(d, d => d[1]))])
                    .range([h - 100, 0])
                    .nice();

                const color = d3.scaleOrdinal(d3.schemeCategory10)
                    .domain(years);

                const area = d3.area()
                    .x((d, i) => xScale(d.data.åœ°åŒº) + xScale.bandwidth() / 2) // å°† x è½´ä½ç½®è°ƒæ•´åˆ°ä¸­å¿ƒ
                    .y0((d, i) => yScale(d[0]))
                    .y1((d, i) => yScale(d[1]))
                    .curve(d3.curveBasis);

                const g = svg.append('g')
                    .attr('transform', `translate(50, 50)`);

                g.selectAll('path')
                    .data(stackedData)
                    .enter()
                    .append('path')
                    .attr('d', area)
                    .attr('fill', d => color(d.key));

                const xAxis = d3.axisBottom(xScale);
                const yAxis = d3.axisLeft(yScale).ticks(10);

                g.append('g')
                    .attr('transform', `translate(0, ${h - 100})`)
                    .call(xAxis)
                    .selectAll('text')
                    .attr('transform', 'rotate(-40)')
                    .style('text-anchor', 'end');

                g.append('g').call(yAxis);

                svg.append('g')
                    .attr('transform', `translate(${w / 2}, 30)`)
                    .append('text')
                    .attr('fill', 'black')
                    .attr('font-size', 20)
                    .text(`å„åœ°åŒºç”¨ç”µé‡é¢ç§¯å›¾`);

                // æ·»åŠ å›¾ä¾‹
                const legend = svg.append('g')
                    .attr('transform', `translate(${w - 150}, 50)`);

                years.forEach((year, i) => {
                    const legendRow = legend.append('g')
                        .attr('transform', `translate(0, ${i * 20})`);

                    legendRow.append('rect')
                        .attr('width', 10)
                        .attr('height', 10)
                        .attr('fill', color(year));

                    legendRow.append('text')
                        .attr('x', 20)
                        .attr('y', 10)
                        .attr('text-anchor', 'start')
                        .style('text-transform', 'capitalize')
                        .text(year);
                });
            });
        }

        function renderAreaChartForwater() {
            const h = document.getElementById('bottomright').clientHeight; // è·å–å³ä¸‹è§’å®¹å™¨é«˜åº¦
            const w = document.getElementById('bottomright').clientWidth; // è·å–å³ä¸‹è§’å®¹å™¨å®½åº¦
            const svg = d3.select('#bottomright') // ä¿®æ”¹é€‰æ‹©å™¨ä¸ºå³ä¸‹è§’å®¹å™¨
                .append('svg')
                .attr('id', 'water_area_chart')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);

            d3.csv('/Resources/data/water_supply.csv').then(function(data) {
                data = data.filter(d => d.åœ°åŒº !== "å…¨å›½");
                const years = ['å…¨å¹´ä¾›æ°´æ€»é‡(ä¸‡ç«‹æ–¹ç±³)'];
                const regions = Array.from(new Set(data.map(d => d.åœ°åŒº)));

                const stackedData = d3.stack()
                    .keys(years)
                    .value((d, key) => +d[key])
                    .offset(d3.stackOffsetNone)
                    (data);

                const xScale = d3.scaleBand()
                    .domain(regions)
                    .range([0, w - 100]) // å°†å®½åº¦æ”¹ä¸º w - 100
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(stackedData, d => d3.max(d, d => d[1]))])
                    .range([h - 100, 0])
                    .nice();

                const color = d3.scaleOrdinal(d3.schemeCategory10)
                    .domain(years);

                const area = d3.area()
                    .x((d, i) => xScale(d.data.åœ°åŒº) + xScale.bandwidth() / 2) // å°† x è½´ä½ç½®è°ƒæ•´åˆ°ä¸­å¿ƒ
                    .y0((d, i) => yScale(d[0]))
                    .y1((d, i) => yScale(d[1]))
                    .curve(d3.curveBasis);

                const g = svg.append('g')
                    .attr('transform', `translate(50, 50)`);

                g.selectAll('path')
                    .data(stackedData)
                    .enter()
                    .append('path')
                    .attr('d', area)
                    .attr('fill', d => color(d.key));

                const xAxis = d3.axisBottom(xScale);
                const yAxis = d3.axisLeft(yScale).ticks(10);

                g.append('g')
                    .attr('transform', `translate(0, ${h - 100})`)
                    .call(xAxis)
                    .selectAll('text')
                    .attr('transform', 'rotate(-40)')
                    .style('text-anchor', 'end');

                g.append('g').call(yAxis);

                svg.append('g')
                    .attr('transform', `translate(${w / 2}, 30)`)
                    .append('text')
                    .attr('fill', 'black')
                    .attr('font-size', 20)
                    .text(`å„åœ°åŒºç”¨æ°´æ€»é‡é¢ç§¯å›¾`);

                // æ·»åŠ å›¾ä¾‹
                const legend = svg.append('g')
                    .attr('transform', `translate(${w - 150}, 50)`);

                years.forEach((year, i) => {
                    const legendRow = legend.append('g')
                        .attr('transform', `translate(0, ${i * 20})`);

                    legendRow.append('rect')
                        .attr('width', 10)
                        .attr('height', 10)
                        .attr('fill', color(year));

                    legendRow.append('text')
                        .attr('x', 20)
                        .attr('y', 10)
                        .attr('text-anchor', 'start')
                        .style('text-transform', 'capitalize')
                        .text(year);
                });
            });
        }

        function renderElectricityGrowth() {
            const h = document.getElementById('topleft').clientHeight;
            const w = document.getElementById('topleft').clientWidth;
            const svg = d3.select('#topleft')
                .append('svg')
                .attr('id', 'electricity_growth')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);

            d3.csv('/Resources/data/electricity_usage.csv').then(function(data) {
                data = data.filter(d => d.åœ°åŒº !== "æ€»ç”¨ç”µé‡");
                const years = ['1995', '2000', '2005', '2010', '2015', '2019', '2020'];
                const regions = Array.from(new Set(data.map(d => d.åœ°åŒº)));

                const stackedData = d3.stack()
                    .keys(years)
                    .value((d, key) => +d[key])
                    (data);

                const xScale = d3.scaleBand()
                    .domain(regions)
                    .range([0, w - 200])  // è°ƒæ•´å®½åº¦ä»¥ç•™å‡ºç©ºé—´æ”¾ç½®å›¾ä¾‹
                    .padding(0.1);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(stackedData, d => d3.max(d, d => d[1]))])
                    .range([h - 100, 0])
                    .nice();

                const color = d3.scaleOrdinal(d3.schemeCategory10)
                    .domain(years);

                const g = svg.append('g')
                    .attr('transform', `translate(50, 50)`);

                g.selectAll('g')
                    .data(stackedData)
                    .enter()
                    .append('g')
                    .attr('fill', d => color(d.key))
                    .selectAll('rect')
                    .data(d => d)
                    .enter()
                    .append('rect')
                    .attr('x', d => xScale(d.data.åœ°åŒº))
                    .attr('y', d => yScale(d[1]))
                    .attr('height', d => yScale(d[0]) - yScale(d[1]))
                    .attr('width', xScale.bandwidth());

                const xAxis = d3.axisBottom(xScale);
                const yAxis = d3.axisLeft(yScale).ticks(10);

                g.append('g')
                    .attr('transform', `translate(0, ${h - 100})`)
                    .call(xAxis)
                    .selectAll('text')
                    .attr('transform', 'rotate(-40)')
                    .style('text-anchor', 'end');

                g.append('g').call(yAxis);

                svg.append('g')
                    .attr('transform', `translate(${w / 2}, 30)`)
                    .append('text')
                    .attr('fill', 'black')
                    .attr('font-size', 20)
                    .text(`å„åœ°åŒºç”¨ç”µé‡å¢é•¿åˆ†æ`);

                // æ·»åŠ å›¾ä¾‹
                const legend = svg.append('g')
                    .attr('transform', `translate(${w - 150}, 50)`); // å°†å›¾ä¾‹æ”¾åœ¨å³ä¾§

                years.forEach((year, i) => {
                    const legendRow = legend.append('g')
                        .attr('transform', `translate(0, ${i * 20})`);

                    legendRow.append('rect')
                        .attr('width', 10)
                        .attr('height', 10)
                        .attr('fill', color(year));

                    legendRow.append('text')
                        .attr('x', 20)
                        .attr('y', 10)
                        .attr('text-anchor', 'start')
                        .style('text-transform', 'capitalize')
                        .text(year);
                });
            });
        }

        function Urban_Facilities_scatter(province) {
            
            const h = document.getElementById('bottomright').clientHeight;
            const w = document.getElementById('bottomright').clientWidth;
            const svg = d3.select('#bottomright')
                .append('svg')
                .attr('id', 'Facilities_scatter')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);


            d3.csv('./Resources/data/urban_facilities-.csv').then(function(data) {
                const xScale = d3.scaleLinear()
                    .domain([0, 30])
                    .range([0, w - 200])
    
                const yScale = d3.scaleLinear()
                    .domain([ 20,5])
                    .range([0, h - 100])

                    
                svg.append('g')
                    .attr('transform', `translate(100,0)`)
                    .call(d3.axisLeft(yScale).tickSize(0))
                    .selectAll('text')
                    .attr('font-size', '16px');
    
                svg.append('g')
                    .attr('transform', `translate(100,${h - 100})`)
                    .call(d3.axisBottom(xScale).ticks(10))
                    .selectAll('text')
                    .attr('font-size', '16px');
    
                svg.append('text')
                    .attr('x', w / 2)
                    .attr('y', 30)
                    .attr('text-anchor', 'middle')
                    .attr('font-size', '20px')
                    .attr('fill', 'black')
                    .text(`æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾† - äººå‡åŸå¸‚é“è·¯é¢ç§¯`);



                svg.append("g")
                    .attr("stroke", "steelblue")
                    .attr("stroke-width", 1.5)
                    .attr("fill", "none")
                    .selectAll("circle")
                    .data(data)
                    .join("circle")
                    .attr("cx", d => xScale (d.äººå‡åŸå¸‚é“è·¯é¢ç§¯)+50)
                    .attr("cy", d => yScale (d.æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†))
                    .attr("r", 3);


                    svg.append("g")
                    .attr("font-family", "sans-serif")
                    .attr("font-size", 10)
                    .selectAll("text")
                    .data(data)
                    .join("text")
                    .attr("dy", "0.35em")
                    .attr("x", d => xScale (d.äººå‡åŸå¸‚é“è·¯é¢ç§¯)+57)
                    .attr("y", d => yScale (d.æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†))
                    .text(d => d.åœ°åŒº);
            });

        }
        function Urban_Facilities_bar(province) {
        const h = document.getElementById('topright').clientHeight;
        const w = document.getElementById('topright').clientWidth;
        const svg = d3.select('#topright')
            .append('svg')
            .attr('id', 'Facilities_bar')
            .attr('width', `${w}px`)
            .attr('height', `${h}px`);
        d3.csv('./Resources/data/urban_facilities.csv').then(function(data) {
            const provinceData = data.find(d => d.åœ°åŒº === province);
            if (!provinceData) return;

            const dataset = [
                { name: 'ä¾›æ°´', value: +provinceData['åŸå¸‚ä¾›æ°´æ™®åŠç‡(%)'] },
                { name: 'ç‡ƒæ°”', value: +provinceData['åŸå¸‚ç‡ƒæ°”æ™®åŠç‡(%)'] },
                { name: 'å…¬äº¤è½¦', value: +provinceData['æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±æ±½ç”µè½¦è¾†(æ ‡å°)'] },
                { name: 'é“è·¯', value: +provinceData['äººå‡åŸå¸‚é“è·¯é¢ç§¯(å¹³æ–¹ç±³)'] },
                { name: 'ç»¿åœ°', value: +provinceData['äººå‡å…¬å›­ç»¿åœ°é¢ç§¯(å¹³æ–¹ç±³)'] },
                { name: 'å•æ‰€', value: +provinceData['æ¯ä¸‡äººæ‹¥æœ‰å…¬å…±å•æ‰€(åº§)'] }
            ];

            const maxValue = d3.max(dataset, d => d.value);
            const xScale = d3.scaleLinear()
                .domain([0, maxValue])
                .range([0, w - 200])
                .nice();

            const yScale = d3.scaleBand()
                .domain(dataset.map(d => d.name))
                .range([0, h - 100])
                .padding(0.1);

            const colorScale = d3.scaleOrdinal(d3.schemeCategory10)
                .domain(dataset.map(d => d.name));

            svg.append('g')
                .selectAll('rect')
                .data(dataset)
                .enter()
                .append('rect')
                .attr('x', 100)
                .attr('y', d => yScale(d.name))
                .attr('width', d => xScale(d.value))
                .attr('height', yScale.bandwidth())
                .attr('fill', d => colorScale(d.name));

            svg.append('g')
                .attr('transform', `translate(100,0)`)
                .call(d3.axisLeft(yScale).tickSize(0))
                .selectAll('text')
                .attr('font-size', '16px');

            svg.append('g')
                .attr('transform', `translate(100,${h - 100})`)
                .call(d3.axisBottom(xScale).ticks(10))
                .selectAll('text')
                .attr('font-size', '16px');

            svg.append('text')
                .attr('x', w / 2)
                .attr('y', 30)
                .attr('text-anchor', 'middle')
                .attr('font-size', '20px')
                .attr('fill', 'black')
                .text(`${province} - åŸå¸‚è®¾æ–½æ™®åŠç‡`);
        });
    }

         //ç»˜åˆ¶åœ°å›¾æ¨¡å—
         function renderMap(year, type) {
            const h = document.getElementById('topleft').clientHeight;
            const w = document.getElementById('topleft').clientWidth;
            const svg = d3.select('#topleft')
                .append('svg')
                .attr('id', 'map')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`);

            const margin = {
                top: 10,
                left: 10,
                bottom: 10,
                right: 10
            };
            const innerWidth = w - margin.left - margin.right;
            const innerHeight = h - margin.top - margin.bottom;

            const projection = d3.geoMercator()
                .center([103, 39])
                .scale(600)
                .translate([innerWidth / 2, innerHeight / 2]);

            const path = d3.geoPath().projection(projection);
            const colors = d3.scaleOrdinal(d3.schemeCategory10);

            // æ£€æŸ¥ year æ˜¯å¦æ˜¯æ•°å­—
            if (!isNaN(year)) {
                svg.append('g').attr('transform', `translate(${w / 2-50},${h / 2-185})`)
                    .append('rect')
                    .attr('fill', "#40d8ab")
                    .attr('width', '110')
                    .attr('height', '50');

                svg.append('g').attr('transform', `translate(${w / 2-45},${h / 2-150})`)
                    .append('text')
                    .attr('fill', '#faf7f4')
                    .attr('font-size', 30)
                    .text(`${year}å¹´`);
            }

            d3.json('./Resources/data/china.geojson').then(data => {
                svg.selectAll('path')
                    .data(data.features)
                    .enter()
                    .append('path')
                    .attr('d', path)
                    .attr('opacity', 0.6)
                    .attr('fill', '#7f8efd')
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 1)
                    .on('mouseenter', function(d) {
                        d3.select(this).attr('opacity', 1);
                        province = d3.select(this)._groups[0][0].__data__.properties.name;
                        d3.select("#pie").remove();
                        d3.select('#bar2').remove();
                        tooltip.style('visibility', 'visible')
                            .style('left', `${d3.pointer(event)[0] + margin.left + 20 + 'px'}`)
                            .style('top', `${d3.pointer(event)[1] + margin.top + 'px'}`);
                        if (type === 'population') {
                            renderbar2(province);
                            Regional_data_population(province, year, svg, path);
                        } else if (type === 'electricity') {
                            Regional_data_electricity(province, year, svg, path);
                            draw_electricity_LineChart(province);
                        } else if (type === 'transportation') {
                            Regional_data_transportation(province, year, svg, path); // æ·»åŠ è¿™è¡Œ
                            renderPieForTransportation(province);
                        } else if (type === 'facilities') {
                            Regional_data_urban_facilities(province, year, svg, path);
                            d3.select("#Facilities_bar").remove(); // æ¸…é™¤ä¹‹å‰çš„æŸ±çŠ¶å›¾
                            Urban_Facilities_bar(province);
                        } else if (type === 'water_supply') {
                            Regional_data_water_supply(province, year, svg, path);
                            renderPieForWater(province);
                        }
                    })
                    .on('mouseleave', function(d) {
                        d3.select(this).attr('opacity', 0.6);
                        tooltip.style('visibility', 'hidden');
                    });
            });
        }

        // æŠ˜çº¿å›¾å’ŒæŸ±çŠ¶å›¾
        function renderline() {
            const h = document.getElementById('topright').clientHeight
            const w = document.getElementById('topright').clientWidth
            const svg = d3.select('#topright')
                .append('svg')
                .attr('id', 'line')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`)

            d3.csv('./Resources/data/population_rate.csv').then(function(data) {
                const maxValue = 160000
                const maxvaluel = 3
                const years = d3.map(data, d => d.å¹´ä»½)
                const height = 300
                const width = 400
                const yScale = d3.scaleLinear()
                    .domain([0, maxValue])
                    .range([height, 0])
                    .nice()
                const yScalel = d3.scaleLinear()
                    .domain([0, maxvaluel])
                    .range([height, 0])
                    .nice()

                const xScale = d3.scaleBand()
                    .domain(years)
                    .range([0, width])
                    .padding(0.05)

                const g = svg.append('g').attr('transform', `translate(${100} ,${50})`)

                g.selectAll('rect')
                    .data(data)
                    .enter()
                    .append('rect')
                    .attr('x', d => xScale(d.å¹´ä»½))
                    .attr('width', d => xScale.bandwidth())
                    .attr('height', function(d) {
                        setdata = d.æ€»äººå£
                        da = setdata / maxValue * height
                        return da
                    })
                    .attr('transform', (d, i) => {
                        let translate = [0, height - d.æ€»äººå£ / maxValue * height]
                        return 'translate(' + translate + ')'
                    })
                    .attr('fill', '#417568')
                    .on('mouseenter', function(d) {
                        d3.select(this).attr('fill', '#d98214')
                        d3.select('#rose').remove()
                        d3.select('#map').remove()
                        const year = d3.select(this)._groups[0][0].__data__.å¹´ä»½
                        renderCom(year)
                        renderMap(year)
                    })
                    .on('mouseleave', function() {
                        d3.select(this).attr('fill', '#417568')
                    })

                g.selectAll('text')
                    .data(data)
                    .enter()
                    .append('text')
                    .attr('fill', 'white')
                    .attr('font-size', '14px')
                    .attr('x', d => xScale(d.å¹´ä»½) - 20)
                    .attr('y', function(d) {
                        return height - d.æ€»äººå£ / maxValue * height
                    })
                    .attr('dx', xScale.bandwidth() / 2)
                    .attr('dy', '1em')
                    .text(d => d.æ€»äººå£)

                const xAxis = d3.axisBottom(xScale).ticks(5) //.tickFormat(d3.format('.0%'))
                const yAxis = d3.axisLeft(yScale).tickSize(5).ticks(10) //Yè½´
                const yAxisl = d3.axisRight(yScalel).tickSize(5).ticks(5)

                g.append('g').attr('transform', `translate(0, ${height})`).call(xAxis)
                g.append('g').call(yAxis)
                g.append('g').call(yAxisl).attr('transform', `translate(${width},0)`)

                d3.selectAll('.tick text').attr('font-size', '16px')

                g.append('g').selectAll('circle')
                    .data(data)
                    .enter()
                    .append('circle')
                    .attr('r', 3)
                    .attr('cx', function(d, i) {
                        return width / 7 * i + width / 14
                    })
                    .attr('cy', function(d) {
                        return height - d.å¢é•¿ç‡ / maxvaluel * height
                    })

                const lineGenerator = d3.line()
                    .x(function(d, i) {
                        return width / 7 * i + width / 14
                    })
                    .y(function(d) {
                        return height - d.å¢é•¿ç‡ / maxvaluel * height
                    })

                g.append('g').append('path') //ç»˜åˆ¶ç›´çº¿é€šè¿‡pathå…ƒç´ å®ç°       
                    .attr('d', lineGenerator(data)) //è°ƒç”¨ç”Ÿæˆå™¨å®ä¾‹ï¼ŒæŒ‰ç…§æ•°æ®é¡ºåºç”Ÿæˆçº¿æ®µ 
                    .attr('fill', 'none') //éœ€è¦è®¾ç½®å¡«å……å±æ€§ï¼Œå¦åˆ™ä¼šè‡ªåŠ¨å¡«å……
                    .attr('stroke', 'red')
                    .attr('stroke-width', 2)

                g.append('g').selectAll('text')
                    .data(data)
                    .enter()
                    .append('text')
                    .attr('fill', 'black')
                    .attr('font-size', '14px')
                    .attr('x', function(d, i) {
                        return width / 7 * i + width / 14
                    })
                    .attr('y', function(d) {
                        return height - d.å¢é•¿ç‡ / maxvaluel * height
                    })
                    .text(d => d.å¢é•¿ç‡)

                d3.select("#line").append('g').attr('transform', `translate(${w / 2+150},${h / 2-170})`)
                    .append('text')
                    .attr('fill', 'black')
                    .attr('font-size', 20)
                    .text('å¢é•¿ç‡ï¼ˆ%ï¼‰')
                d3.select("#line").append('g').attr('transform', `translate(${w / 2-300},${h / 2-170})`)
                    .append('text')
                    .attr('fill', 'black')
                    .attr('font-size', 20)
                    .text('æ€»äººå£ï¼ˆä¸‡äººï¼‰')
            })
        }


        // ç»˜åˆ¶é¥¼å›¾æ¨¡å—
        function renderCom(year) {
            const h = document.getElementById('bottomleft').clientHeight
            const w = document.getElementById('bottomleft').clientWidth
            const svg = d3.select('#bottomleft')
                .append('svg')
                .attr('id', 'rose')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`)

            d3.csv('./Resources/data/population_rate.csv').then(function(data) {
                for (i in data) {
                    if (data[i].å¹´ä»½ == year) {
                        const pie = d3.pie()
                            .value(d => d.value)
                            .sort(null)
                            .padAngle(0.02)

                        //å—æ•™è‚²ç¨‹åº¦
                        const color = d3.scaleOrdinal(d3.schemeCategory10)
                        const length = 4 //åœ†å¼§æ•°é‡
                        const per = 2 * Math.PI / length
                        const pieData = [data[i].å¤§å­¦, data[i].é«˜ä¸­, data[i].åˆä¸­, data[i].å°å­¦]
                        const sum = d3.sum(pieData)
                        const start = [0, +data[i].å¤§å­¦, +data[i].é«˜ä¸­, +data[i].åˆä¸­]
                        const end = [+data[i].å¤§å­¦, +data[i].é«˜ä¸­, +data[i].åˆä¸­, sum]
                        const dataset1 = [{
                            name: `å¤§å­¦`,
                            value: data[i].å¤§å­¦,
                            ratio: `${Math.round((+data[i].å¤§å­¦)/(+sum)*10000)/100}%`
                        }, {
                            name: `é«˜ä¸­`,
                            value: data[i].é«˜ä¸­,
                            ratio: `${Math.round((+data[i].é«˜ä¸­)/(+sum)*10000)/100}%`
                        }, {
                            name: `åˆä¸­`,
                            value: data[i].åˆä¸­,
                            ratio: `${Math.round((+data[i].åˆä¸­)/(+sum)*10000)/100}%`
                        }, {
                            name: `å°å­¦`,
                            value: data[i].å°å­¦,
                            ratio: `${Math.round((+data[i].å°å­¦)/(+sum)*10000)/100}%`
                        }]
                        const dataset = d3.range(length).map(function(i) {
                            return {
                                innerRadius: 45,
                                outerRadius: 45 + 15 * (i + 1),
                                startAngle: 2 * Math.PI * start[i] / sum,
                                endAngle: 2 * Math.PI * end[i] / sum
                            }
                        })

                        const color1 = ['#e36f30', '#ad5852', '#724669', '#898aa5']
                        const RoseChart1 = svg.append('g')
                            .attr('transform', 'translate(130,180)')
                        const pie_data1 = pie(dataset1)

                        const arc1 = d3.arc()
                            .outerRadius(100)
                            .innerRadius(50)
                            .cornerRadius(5)
                        const slices1 = RoseChart1.selectAll('path')
                            .data(pie_data1)
                            .enter()
                            .append('path')
                            .attr('fill', function(d, i) {
                                return color1[d.index]
                            })
                            .attr('d', d => arc1(d))

                        const label1 = RoseChart1.selectAll('text')
                            .data(pie_data1)
                            .enter()
                            .append('text')
                            .attr('fill', 'black')
                            .attr('transform', d => `translate(${arc1.centroid(d)})`) //è®¡ç®—å¹³é¢è´¨å¿ƒä½ç½®
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.ratio)

                        const tips1 = svg.append('g')
                            .attr('transform', 'translate(50,40)')
                        const tip1 = tips1.selectAll('rect')
                            .data(pie_data1)
                            .enter()
                            .append('rect')
                            .attr('fill', function(d, i) {
                                return color1[i]
                            })
                            .attr('width', '40')
                            .attr('height', '30')
                            .attr('transform', (d, i) => {
                                let translate = [i * 40, 0]
                                return 'translate(' + translate + ')'
                            })
                        const tip_text1 = svg.append('g').attr('transform', 'translate(70,60)').selectAll('text')
                            .data(pie_data1)
                            .enter()
                            .append('text')
                            .attr('fill', 'white')
                            .attr('transform', (d, i) => {
                                let translate = [i * 40, 0]
                                return 'translate(' + translate + ')'
                            })
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.name)
                        d3.select("#rose").append('g').attr('transform', `translate(${w / 2-440},${h / 2+40})`)
                            .append('text')
                            .attr('fill', 'black')
                            .attr('font-size', 30)
                            .text(`æ•™è‚²`)

                        //å¹´é¾„æ¯”
                        const dataset2 = [{
                            name: `14å²åŠä»¥ä¸‹`,
                            value: data[i].åå››å²åŠä»¥ä¸‹,
                            ratio: `${data[i].åå››å²åŠä»¥ä¸‹}%`
                        }, {
                            name: `15å²åˆ°59å²`,
                            value: data[i].åäº”å²åˆ°äº”åä¹å²,
                            ratio: `${data[i].åäº”å²åˆ°äº”åä¹å²}%`
                        }, {
                            name: `60å²åŠä»¥ä¸Š`,
                            value: data[i].å…­åå²åŠä»¥ä¸Š,
                            ratio: `${data[i].å…­åå²åŠä»¥ä¸Š}%`
                        }]

                        const PieGroup = svg.append('g')
                            .attr('transform', 'translate(400,180)')



                        const pie_data2 = pie(dataset2)

                        const arc2 = d3.arc()
                            .outerRadius(100)
                            .innerRadius(50)
                            .cornerRadius(5)
                        const color2 = ['#7ec9b0', '#428872', '#d98214']
                        const slices = PieGroup.selectAll('path')
                            .data(pie_data2)
                            .enter()
                            .append('path')
                            .attr('fill', function(d, i) {
                                return color2[d.index]
                            })
                            .attr('d', d => arc2(d))

                        const labels = PieGroup.selectAll('text')
                            .data(pie_data2)
                            .enter()
                            .append('text')
                            .attr('fill', 'black')
                            .attr('transform', d => `translate(${arc2.centroid(d)})`) //è®¡ç®—å¹³é¢è´¨å¿ƒä½ç½®
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.ratio)

                        const tips = svg.append('g')
                            .attr('transform', 'translate(270,40)')
                        const tip2 = tips.selectAll('rect')
                            .data(pie_data2)
                            .enter()
                            .append('rect')
                            .attr('fill', function(d, i) {
                                return color2[i]
                            })
                            .attr('width', '90')
                            .attr('height', '30')
                            .attr('transform', (d, i) => {
                                let translate = [i * 90, 0]
                                return 'translate(' + translate + ')'
                            })
                        const tip_text2 = svg.append('g').attr('transform', 'translate(310,60)').selectAll('text')
                            .data(pie_data2)
                            .enter()
                            .append('text')
                            .attr('fill', 'white')
                            .attr('transform', (d, i) => {
                                let translate = [i * 90, 0]
                                return 'translate(' + translate + ')'
                            })
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.name)
                        d3.select("#rose").append('g').attr('transform', `translate(${w / 2-170},${h / 2+30})`)
                            .append('text')
                            .attr('fill', 'black')
                            .attr('font-size', 30)
                            .text(`å¹´é¾„`)



                        //æ€§åˆ«æ¯”
                        const datasetp3 = [{
                            name: `ç”·`,
                            value: data[i].ç”·,
                            ratio: `${Math.round(+data[i].ç”·/(+data[i].ç”·+(+data[i].å¥³))*10000)/100}%`
                        }, {
                            name: `å¥³`,
                            value: data[i].å¥³,
                            ratio: `${Math.round(+data[i].å¥³/(+data[i].ç”·+(+data[i].å¥³))*10000)/100}%`
                        }]

                        const PieGroup3 = svg.append('g')
                            .attr('transform', 'translate(650,180)')

                        const pie_data3 = pie(datasetp3) //ç”¨æ•°æ®å®ä¾‹åŒ–é¥¼å›¾ç”Ÿæˆå™¨

                        const arc3 = d3.arc()
                            .outerRadius(100)
                            .innerRadius(50)
                            .cornerRadius(5)

                        const color3 = ['#43a2a9', '#e47e60']
                        const slices3 = PieGroup3.selectAll('path')
                            .data(pie_data3)
                            .enter()
                            .append('path')
                            .attr('fill', function(d, i) {
                                return color3[d.index]
                            })
                            .attr('d', d => arc3(d))

                        const labels3 = PieGroup3.selectAll('text')
                            .data(pie_data3)
                            .enter()
                            .append('text')
                            .attr('fill', 'black')
                            .attr('transform', d => `translate(${arc3.centroid(d)})`) //è®¡ç®—å¹³é¢è´¨å¿ƒä½ç½®
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.ratio)

                        const tips3 = svg.append('g')
                            .attr('transform', 'translate(600,40)')
                        const tip3 = tips3.selectAll('rect')
                            .data(pie_data3)
                            .enter()
                            .append('rect')
                            .attr('fill', function(d, i) {
                                return color3[i]
                            })
                            .attr('width', '50')
                            .attr('height', '30')
                            .attr('transform', (d, i) => {
                                let translate = [i * 50, 0]
                                return 'translate(' + translate + ')'
                            })
                        const tip_text3 = svg.append('g').attr('transform', 'translate(620,60)').selectAll('text')
                            .data(pie_data3)
                            .enter()
                            .append('text')
                            .attr('fill', 'white')
                            .attr('transform', (d, i) => {
                                let translate = [i * 50, 0]
                                return 'translate(' + translate + ')'
                            })
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.name)
                        d3.select("#rose").append('g').attr('transform', `translate(${w / 2+80},${h / 2+30})`)
                            .append('text')
                            .attr('fill', 'black')
                            .attr('font-size', 30)
                            .text(`æ€§åˆ«`)

                        
                    }
                }
            })
        }

        // ç»˜åˆ¶ä¾›æ°´æƒ…å†µçš„é¥¼å›¾æ¨¡å—
        function renderPieForWater(province) {
            const width = 400;
            const height = 400;
            const margin = { top: 50, right: 50, bottom: 50, left: 50 };

            // ç§»é™¤ä¹‹å‰çš„SVGå®¹å™¨å’Œæ‰€æœ‰å­å…ƒç´ 
            d3.select('#topright').selectAll('svg').remove();

            // åˆ›å»ºæ–°çš„SVGå®¹å™¨
            const svg = d3.select('#topright')
                .append('svg')
                .attr('id', 'line') // è®¾ç½®SVGçš„IDä¸ºline
                .attr('width', width + margin.left + margin.right) // è®¾ç½®SVGå®½åº¦
                .attr('height', height + margin.top + margin.bottom); // è®¾ç½®SVGé«˜åº¦

            d3.csv('./Resources/data/water_supply.csv').then(function(data) {
                for (let i in data) {
                    if (data[i].åœ°åŒº == province) {
                        const pie = d3.pie()
                            .value(d => d.value)
                            .sort(null)
                            .padAngle(0.02);

                        const color = d3.scaleOrdinal(d3.schemeCategory10);
                        const length = 2; // åœ†å¼§æ•°é‡
                        const pieData = [data[i].ç”Ÿæ´»ç”¨æ°´, data[i].ç”Ÿäº§ç”¨æ°´];
                        const sum = d3.sum(pieData);
                        const dataset1 = [{
                            name: `ç”Ÿæ´»ç”¨æ°´`,
                            value: data[i].ç”Ÿæ´»ç”¨æ°´,
                            ratio: `${Math.round((+data[i].ç”Ÿæ´»ç”¨æ°´) / (+sum) * 10000) / 100}%`
                        }, {
                            name: `ç”Ÿäº§ç”¨æ°´`,
                            value: data[i].ç”Ÿäº§ç”¨æ°´,
                            ratio: `${Math.round((+data[i].ç”Ÿäº§ç”¨æ°´) / (+sum) * 10000) / 100}%`
                        }];

                        const color1 = ['#1f77b4', '#2ca02c']; // ä½¿ç”¨è“è‰²ç›¸å…³çš„é¢œè‰²
                        const RoseChart1 = svg.append('g')
                            .attr('transform', 'translate(250,200)'); // å‘å³ç§»åŠ¨å¹¶ç¨å¾®æ”¾å¤§é¥¼å›¾ä½ç½®
                        const pie_data1 = pie(dataset1);

                        const arc1 = d3.arc()
                            .outerRadius(120) // ç¨å¾®æ”¾å¤§é¥¼å›¾
                            .innerRadius(60)
                            .cornerRadius(5);

                        const slices1 = RoseChart1.selectAll('path')
                            .data(pie_data1)
                            .enter()
                            .append('path')
                            .attr('fill', function(d, i) {
                                return color1[d.index];
                            })
                            .attr('d', d => arc1(d));

                        const label1 = RoseChart1.selectAll('text')
                            .data(pie_data1)
                            .enter()
                            .append('text')
                            .attr('fill', 'black')
                            .attr('transform', d => `translate(${arc1.centroid(d)})`) // è®¡ç®—å¹³é¢è´¨å¿ƒä½ç½®
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.ratio);

                        const tips1 = svg.append('g')
                            .attr('transform', 'translate(50,40)');
                        const tip1 = tips1.selectAll('rect')
                            .data(pie_data1)
                            .enter()
                            .append('rect')
                            .attr('fill', function(d, i) {
                                return color1[i];
                            })
                            .attr('width', '70')
                            .attr('height', '30')
                            .attr('transform', (d, i) => {
                                let translate = [i * 70, 0]; // è°ƒæ•´é—´è·
                                return 'translate(' + translate + ')';
                            });
                            
                        const tip_text1 = svg.append('g').attr('transform', 'translate(80,60)').selectAll('text')
                            .data(pie_data1)
                            .enter()
                            .append('text')
                            .attr('fill', 'white')
                            .attr('transform', (d, i) => {
                                let translate = [i * 70, 0]; // è°ƒæ•´é—´è·
                                return 'translate(' + translate + ')';
                            })
                            .attr('text-anchor', 'middle')
                            .text(d => d.data.name);

                        svg.append('g').attr('transform', `translate(${w/3  - 100},30)`) // ç¼©å°å¹¶ä¸Šç§»æ ‡é¢˜ä½ç½®
                            .append('text')
                            .attr('fill', 'black')
                            .attr('font-size', 20) // ç¼©å°æ ‡é¢˜
                            .text(`ç”¨æ°´æƒ…å†µ`);
                        break;
                    }
                }
            });
        }

        // ç»˜åˆ¶æ¡å½¢å›¾æ¨¡å—
        function renderbar2(province) {   
            const h = document.getElementById('bottomright').clientHeight
            const w = document.getElementById('bottomright').clientWidth + 40
            const svg = d3.select('#bottomright')
                .append('svg')
                .attr('id', 'bar2')
                .attr('width', `${w}px`)
                .attr('height', `${h}px`)
            d3.csv('./Resources/data/jths.csv').then(function(data) {
                for (i in data) {
                    if (data[i].åœ°åŒº == province) {
                        //ç»˜å›¾
                        const maxValueb = 3000
                        d3.select("#bar2").append('g').attr('transform', `translate(${w / 2+150},${h / 2-50})`)
                            .append('text')
                            .attr('fill', 'black')
                            .attr('font-size', 30)
                            .text(`${province}`)
                        const dataset = [{
                            name: 'æµå…¥',
                            value: data[i].æµå…¥
                        }, {
                            name: 'æµå‡º',
                            value: data[i].æµå‡º
                        }]

                        const hushu = d3.map(dataset, data => data.name)
                        const barHeightb = 200
                        const xScaleb = d3.scaleLinear()
                            .domain([0, maxValueb])
                            .range([0, 600])
                            .nice() //åˆ»åº¦ä¼˜åŒ–
                        d3.select("#bar2").append('g').attr('transform', `translate(${xScaleb(data[i].æµå‡º)+100},${h / 2-50})`)
                            .append('text')
                            .attr('fill', 'black')
                            .attr('font-size', 20)
                            .text(`${data[i].æµå‡º}ä¸‡äºº`)
                        d3.select("#bar2").append('g').attr('transform', `translate(${xScaleb(data[i].æµå…¥)+100},${h / 2+50})`)
                            .append('text')
                            .attr('fill', 'black')
                            .attr('font-size', 20)
                            .text(`${data[i].æµå…¥}ä¸‡äºº`)
                        const yScaleb = d3.scaleBand()
                            .domain(hushu)
                            .range([barHeightb, 0])
                            .padding(0.05)
                        const g = svg.append('g').attr('transform', `translate(${w/2-300}, ${h/2-100})`)
                        const color5 = ['#215182', '#3a84cf']
                        g.selectAll('rect')
                            .data(dataset)
                            .enter()
                            .append('rect')
                            .attr('x', 0)
                            .attr('y', d => yScaleb(d.name))
                            .attr('width', function(d) {
                                return d.value / maxValueb * 600
                            })
                            .attr('height', yScaleb.bandwidth())
                            .attr('fill', function(d, i) {
                                return color5[i]
                            })

                        const xAxisb = d3.axisBottom(xScaleb).ticks(10)
                        const yAxisb = d3.axisLeft(yScaleb).tickSize(0)

                        //ç»˜åˆ¶åæ ‡è½´
                        g.append('g').attr('transform', `translate(0, ${barHeightb})`).call(xAxisb)
                        g.append('g').call(yAxisb)

                        //è®¾ç½®åæ ‡è½´æ–‡æœ¬å­—ä½“å¤§å°
                        d3.selectAll('.tick text').attr('font-size', '16px')

                        break
                    }
                }
            })
        }  
    </script>
</body>

</html>